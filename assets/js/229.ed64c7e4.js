(window.webpackJsonp=window.webpackJsonp||[]).push([[229],{982:function(t,s,a){"use strict";a.r(s);var n=a(27),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("长列表一般也叫虚拟列表，是一种大数据量下只渲染可见节点避免页面卡顿的优化方案")]),t._v(" "),s("blockquote",[s("p",[t._v("长列表也有时间分片的做法，比较少用，感兴趣的可以看 "),s("a",{attrs:{href:"https://juejin.im/post/5d76f469f265da039a28aff7",target:"_blank",rel:"noopener noreferrer"}},[t._v("高性能渲染十万条数据(时间分片)"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("前端比较有名的有两个项目：")]),t._v(" "),s("ul",[s("li",[t._v("react-window")]),t._v(" "),s("li",[t._v("vue-virtual-scroller")])]),t._v(" "),s("p",[t._v("以及 Ant Design 4 的 "),s("a",{attrs:{href:"https://github.com/react-component/virtual-list",target:"_blank",rel:"noopener noreferrer"}},[t._v("virtual-list"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("本文将对这些开源库进行剖析，分析实现原理，并进行各个指标的评估，最终实现一个高可用的长列表组件")]),t._v(" "),s("p",[t._v("主要评估以下几点：")]),t._v(" "),s("ol",[s("li",[t._v("渲染：回流， 渲染策略等")]),t._v(" "),s("li",[t._v("计算：起止项和偏移位置的计算，总高度的计算")]),t._v(" "),s("li",[t._v("功能：自适应高度，其他")]),t._v(" "),s("li",[t._v("健壮：是否存在鼠标与滚动条不同步的 bug（计算时总高度增加了，则滚动条会相对鼠标向上）")])]),t._v(" "),s("p",[t._v("然后说下看源码的策略，主要看这几点：")]),t._v(" "),s("ol",[s("li",[t._v("dom 结构")]),t._v(" "),s("li",[t._v("查找起始位置")]),t._v(" "),s("li",[t._v("计算偏移距离")]),t._v(" "),s("li",[t._v("计算总高度")])]),t._v(" "),s("h2",{attrs:{id:"长列表入门"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#长列表入门"}},[t._v("#")]),t._v(" 长列表入门")]),t._v(" "),s("p",[t._v("如果还不清楚长列表是什么，可以先看下这篇文章"),s("a",{attrs:{href:"https://juejin.im/post/5db684ddf265da4d495c40e5",target:"_blank",rel:"noopener noreferrer"}},[t._v("「前端进阶」高性能渲染十万条数据(虚拟列表)"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("一张图快速入门")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://user-gold-cdn.xitu.io/2019/10/29/16e1519a393dee2c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1",alt:""}})]),t._v(" "),s("p",[t._v("下面我们来看看其他开源库都怎么做的")]),t._v(" "),s("h2",{attrs:{id:"vue-virtual-scroller"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#vue-virtual-scroller"}},[t._v("#")]),t._v(" vue-virtual-scroller")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/Akryum/vue-virtual-scroller",target:"_blank",rel:"noopener noreferrer"}},[t._v("项目地址"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("功能： 支持自适应高度，横向滚动，图片自适应高度")]),t._v(" "),s("h3",{attrs:{id:"渲染"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#渲染"}},[t._v("#")]),t._v(" 渲染")]),t._v(" "),s("p",[t._v("dom 结构如下")]),t._v(" "),s("div",{staticClass:"language-html line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- position: relative;overflow-y: auto; --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("vue-recycle-scroller"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("vue-recycle-scroller__item-wrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{ 'minHeight': totalSize + 'px' }"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("v-for")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("view of pool"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":key")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("view.nr.id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{ transform: `translateY(${view.position}px)` }"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("vue-recycle-scroller__item-view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("slot")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":item")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("view.item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":index")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("view.nr.index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":active")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("view.nr.used"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("p",[t._v("一个相对定位的列表，由 "),s("code",[t._v("min-height")]),t._v(" 撑开 wrapper 以产生滚动条")]),t._v(" "),s("p",[t._v("每个列表项进行平移(translateY),这个偏移值为该项在列表中的高度累加值")]),t._v(" "),s("p",[t._v("还有一些 "),s("code",[t._v("-9999px")]),t._v(" 的不可见元素，这些其实是缓存池列表项，这个在 "),s("strong",[t._v("节点回收复用")]),t._v(" 一节会讲到")]),t._v(" "),s("p",[t._v("列表项数据结构：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("listItem "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 数据项内容")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("item")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 非响应式数据")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("nr")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 唯一标识")]),t._v("\n    index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 数据项中的索引")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("used")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Boolean"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否已用来显示在可视区域")]),t._v("\n    key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 数据项中的key")]),t._v("\n    type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在对应类型的缓冲池中存取")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// translateY 值")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("position")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br")])]),s("p",[t._v("不会产生回流（非自适应高度的情况）")]),t._v(" "),s("p",[t._v("浏览器"),s("strong",[t._v("渲染速度快")]),t._v("：进行滚动时产生变化的列表项会尽可能的使用缓存池元素并修改 translateY ，其他没有变动的列表项在dom结构中的位置不变")]),t._v(" "),s("h3",{attrs:{id:"计算"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#计算"}},[t._v("#")]),t._v(" 计算")]),t._v(" "),s("p",[t._v("有三种场景")]),t._v(" "),s("h4",{attrs:{id:"_1-使用默认高度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-使用默认高度"}},[t._v("#")]),t._v(" ① 使用默认高度")]),t._v(" "),s("p",[t._v("最简单的情况，需要设置 itemSize")]),t._v(" "),s("p",[t._v("起始项索引可以通过 "),s("code",[t._v("~~(scrollTop / itemSize)")]),t._v(" 得到")]),t._v(" "),s("p",[t._v("列表总高度 = "),s("code",[t._v("itemSize * itemCount")])]),t._v(" "),s("h4",{attrs:{id:"_2-定义高度字段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-定义高度字段"}},[t._v("#")]),t._v(" ② 定义高度字段")]),t._v(" "),s("p",[t._v("itemSize 设为 null，通过数据项中的 height 字段定义每个列表项的高度")]),t._v(" "),s("p",[t._v("由于所有列表项高度是确定的，一开始会计算每一项的高度和偏移值")]),t._v(" "),s("blockquote",[s("p",[t._v("O(n) 时间复杂度")])]),t._v(" "),s("p",[t._v("同时确定了列表总高度，固定为 "),s("code",[t._v("最后一项的偏移值+高度")])]),t._v(" "),s("p",[t._v("当进行滚动时，由于每一项的偏移位置是确定的，则查找起始项索引可以采用二分法")]),t._v(" "),s("blockquote",[s("p",[t._v("O(logn) 时间复杂度")])]),t._v(" "),s("h4",{attrs:{id:"_3-自适应高度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-自适应高度"}},[t._v("#")]),t._v(" ③ 自适应高度")]),t._v(" "),s("p",[t._v("需要配置数据项最小高度，并根据这个值初始化每个数据项的高度和偏移值 -- sizes")]),t._v(" "),s("blockquote",[s("p",[t._v("O(n) 时间复杂度")])]),t._v(" "),s("p",[t._v("列表总高度为 "),s("code",[t._v("最后一项的偏移值+高度")])]),t._v(" "),s("p",[t._v("sizes 计算")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" l "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" l"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("field"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" minItemSize\n  accumulator "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" current\n  sizes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" accumulator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("size")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" current "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("进行滚动，通过二分 sizes 得到起始项索引，结束项索引为起始项索引加上 "),s("code",[t._v("可视高度/最小列高")])]),t._v(" "),s("blockquote",[s("p",[t._v("O(logn) 时间复杂度")])]),t._v(" "),s("p",[t._v("之后进行节点渲染，渲染完毕时获取实际高度，并重新计算 sizes 以及列表总高度")]),t._v(" "),s("blockquote",[s("p",[t._v("O(n) 时间复杂度")])]),t._v(" "),s("p",[t._v("总体来说，性能较差，有优化的空间")]),t._v(" "),s("h3",{attrs:{id:"【卖点】节点回收与复用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#【卖点】节点回收与复用"}},[t._v("#")]),t._v(" 【卖点】节点回收与复用")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("连续滚动(continuous): 前后两次查找的数据范围有重叠，比如第一次为 1~10 第二次为 5~14 或者相反\n已使用的列表项(views): 记录已使用项的 Map ，key 为列表项的 key\npool: 页面中所有渲染的列表项，包括未使用的\n类型-缓存池 Map (unusedViews): 记录类型和缓存池的 Map\n缓存池(unusedPool): 某种类型的缓存池，其中的列表项在页面中偏移位置为 -9999px \n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("举个连续滚动的例子：")]),t._v(" "),s("ol",[s("li",[t._v("一开始查到 1~10 放入 views 中，进行滚动，查到 5~14")]),t._v(" "),s("li",[t._v("将 1~4 放入对应类型的 unusedPool 中，设置未使用，并从 views 中删除")]),t._v(" "),s("li",[t._v("将原来的 5~10项 设置为 已使用")]),t._v(" "),s("li",[t._v("查到 11 时，看 unusedPool 中有没有和 11 同类型的，有的话 pop 出来复用，替换下内容和偏移位置，没有的话新建一个 view，会放入 pool 中")])]),t._v(" "),s("p",[t._v("对应的，非连续滚动定义为 "),s("strong",[t._v("快速滚动")]),t._v("，初始化一个空的 map -- unusedIndex, 作用是记录同类型的 unusedPool 需要从哪个索引开始取值。")]),t._v(" "),s("p",[t._v("如果 unusedPool 存在元素，拿来复用；如果同类型 pool 被用光了，addView")]),t._v(" "),s("blockquote",[s("p",[t._v("感觉此处 "),s("code",[t._v("v++")]),t._v(" 的处理有点问题，没有深究")])]),t._v(" "),s("p",[t._v("和安卓的列表滚动类似，按类型进行回收，新找到的列表项会复用缓存中同类型的，可以减少 layout 时间")]),t._v(" "),s("p",[t._v("类似的还有 weex 的 "),s("a",{attrs:{href:"https://weex.apache.org/zh/docs/components/recycle-list.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("recycle-list"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"健壮"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#健壮"}},[t._v("#")]),t._v(" 健壮")]),t._v(" "),s("p",[t._v("由于进度条高度会变化，因此存在鼠标与滚动条不同步的 bug")]),t._v(" "),s("h3",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("功能丰富，自适应高度方面的处理性能不行（尝试考虑pr），项目结构较差不易维护")]),t._v(" "),s("p",[t._v("不建议使用")]),t._v(" "),s("h2",{attrs:{id:"react-window"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#react-window"}},[t._v("#")]),t._v(" react-window")]),t._v(" "),s("p",[t._v("提供四种组件：")]),t._v(" "),s("ul",[s("li",[t._v("FixedSizeList")]),t._v(" "),s("li",[t._v("FixedSizeGrid")]),t._v(" "),s("li",[t._v("VariableSizeList")]),t._v(" "),s("li",[t._v("VariableSizeGrid")])]),t._v(" "),s("p",[t._v("不支持自适应高度")]),t._v(" "),s("p",[t._v("grid 不分析了， FixedSizeList 就是最简单的固定高度的情景，做法都一样，我们直接分析 VariableSizeList")]),t._v(" "),s("blockquote",[s("p",[t._v("先吐个槽， react-window 为了复用，代码封装了一层又一层，render 还是用的 createElement ... 看源码的时候实在难受，而且还是用 flow 写的，编辑器各种报错")])]),t._v(" "),s("p",[t._v("不知道什么原因，依赖安装的时候一直失败，本地没有启动起来，这次是直接看的源码")]),t._v(" "),s("h3",{attrs:{id:"渲染-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#渲染-2"}},[t._v("#")]),t._v(" 渲染")]),t._v(" "),s("div",{staticClass:"language-html line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token special-attr"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),s("span",{pre:!0,attrs:{class:"token value css language-css"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token selector"}},[t._v("position: 'relative', height: `$")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("height"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("px`"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("overflow")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'auto'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token special-attr"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),s("span",{pre:!0,attrs:{class:"token value css language-css"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token selector"}},[t._v("height: `$")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("totalSize"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("px`"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("width")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'100%'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token special-attr"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),s("span",{pre:!0,attrs:{class:"token value css language-css"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("position")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" absolute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("left")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("top")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 38px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("height")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 30px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("width")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 100%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      Row 1\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token special-attr"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),s("span",{pre:!0,attrs:{class:"token value css language-css"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("position")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" absolute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("left")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("top")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 68px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("height")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 65px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("width")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 100%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      Row 2\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    ....\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token special-attr"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),s("span",{pre:!0,attrs:{class:"token value css language-css"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("position")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" absolute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("left")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("top")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 133px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("height")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 70px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("width")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 100%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      Row 3\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br")])]),s("p",[t._v("依然是用一个 totalSize 高度的容器去产生进度条，每个列表项通过绝对定位进行偏移")]),t._v(" "),s("p",[t._v("这里其实用 "),s("code",[t._v("transform: translateY")]),t._v(" 效果一样的，当然渲染上的性能差异我就不知道了")]),t._v(" "),s("h3",{attrs:{id:"计算-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#计算-2"}},[t._v("#")]),t._v(" 计算")]),t._v(" "),s("p",[t._v("和这篇文章的实现一致 -- "),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/34585166",target:"_blank",rel:"noopener noreferrer"}},[t._v("再谈前端虚拟列表的实现"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("貌似对指数搜索有误解？")])]),t._v(" "),s("p",[t._v("设 lastMeasureItem 为已测量的最远元素，")]),t._v(" "),s("p",[t._v("lastMeasureItem.offset 为该元素的偏移值")]),t._v(" "),s("p",[t._v("lastMeasureItem.index 为该元素的索引")]),t._v(" "),s("p",[t._v("列表总高度 = lastMeasureItem.offset + 未测量元素 * 默认高度")]),t._v(" "),s("p",[t._v("初次滚动，从第0项开始测量并缓存已滚动过的元素的偏移和索引，更新 lastMeasureItem")]),t._v(" "),s("blockquote",[s("p",[t._v("O(n) 时间复杂度")])]),t._v(" "),s("p",[t._v("当滚动偏移值小于 "),s("code",[t._v("lastMeasureItem.offset")]),t._v(" 时，表示起始项在 0~lastMeasureItem.index 范围之间，由于该范围所有列表项偏移值都计算过了，此时采用二分即可快速得到起始项索引")]),t._v(" "),s("blockquote",[s("p",[t._v("O(logn)")])]),t._v(" "),s("p",[t._v("当滚动偏移值小于 "),s("code",[t._v("lastMeasureItem.offset")]),t._v(" 时，则以 "),s("code",[t._v("lastMeasureItem.index")]),t._v(" 开始测量并缓存已滚动过的元素的偏移和索引，更新 lastMeasureItem")]),t._v(" "),s("blockquote",[s("p",[t._v("O(n) 时间复杂度")])]),t._v(" "),s("p",[t._v("Watch 观察 lastMeasureItem.index ，若改变，则列表总高度跟着变")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://jsfiddle.net/furybean/teg2ur1b/1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("在线 Demo"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("本方案有两个缺点：")]),t._v(" "),s("ul",[s("li",[t._v("拓展差，做不了自适应高度")]),t._v(" "),s("li",[t._v("前面的滚动较耗时间，把没用到的也计算进去了")])]),t._v(" "),s("h3",{attrs:{id:"健壮-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#健壮-2"}},[t._v("#")]),t._v(" 健壮")]),t._v(" "),s("p",[t._v("由于进度条高度会变化，因此存在鼠标与滚动条不同步的 bug")]),t._v(" "),s("h3",{attrs:{id:"总结-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结-2"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("不支持自适应高度，性能不行，不是 react 长列表的首选方案")]),t._v(" "),s("p",[t._v("如果有用到 Grid 的话可以用")]),t._v(" "),s("h2",{attrs:{id:"virtual-list"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#virtual-list"}},[t._v("#")]),t._v(" virtual-list")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/react-component/virtual-list",target:"_blank",rel:"noopener noreferrer"}},[t._v("项目地址"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("目前分析综合评分最高的一个")])]),t._v(" "),s("p",[t._v("支持自适应高度，支持动画效果，支持滚动位置复原")]),t._v(" "),s("h3",{attrs:{id:"渲染-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#渲染-3"}},[t._v("#")]),t._v(" 渲染")]),t._v(" "),s("div",{staticClass:"language-html line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- 用户可见的容器高度可能只有 300px --\x3e")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token special-attr"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),s("span",{pre:!0,attrs:{class:"token value css language-css"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("width")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 200px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v("height")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 300px"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("@scroll.passive")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("handleScroll"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- 总的列表 div ，用于撑起列表的高度 --\x3e")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("total-list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{\n        height: `${itemHeight * data.length}px`,\n      }"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("visible-list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{\n        transform: `translateY(${topHeight}px)`,\n      }"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("v-for")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("item in visibleList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":key")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("item.id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("visible-list-item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":style")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{\n          height: `${itemHeight}px`,\n        }"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("{{ item.value }}"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- 此处只需渲染可见列表即可，无需渲染全部数据 --\x3e")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br")])]),s("p",[t._v("和上面的方案不一样，这里是创建了一个 total-list 的容器，直接对这个容器进行 translateY 偏移")]),t._v(" "),s("h3",{attrs:{id:"计算-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#计算-3"}},[t._v("#")]),t._v(" 计算")]),t._v(" "),s("p",[t._v("总高度始终固定，等于 "),s("code",[t._v("列表项个数(itemCount) * 列表项最小高度(itemHeight)")])]),t._v(" "),s("p",[t._v("处理逻辑如下：")]),t._v(" "),s("ol",[s("li",[t._v("滚动，确定定位项和起止项")]),t._v(" "),s("li",[t._v("渲染起止列表项")]),t._v(" "),s("li",[t._v("列表项渲染完毕，计算并调整起始项偏移位置")]),t._v(" "),s("li",[t._v("进行重渲染")])]),t._v(" "),s("blockquote",[s("p",[t._v("注意：此处的渲染表示对 dom 进行操作，仍处于宏任务，还未到浏览器实际渲染(UI Render)阶段")])]),t._v(" "),s("p",[s("strong",[t._v("核心思想是任意高度的列表项都占据相同的滚动条范围")])]),t._v(" "),s("h4",{attrs:{id:"_1-确定定位项和起止项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-确定定位项和起止项"}},[t._v("#")]),t._v(" ① 确定定位项和起止项")]),t._v(" "),s("p",[t._v("定位项与滚动条位置对应，可以理解为滚动条水平方向指向的那个列表项。")]),t._v(" "),s("p",[t._v("当滚动条为0时，指向第0项，此时定位项为第0项")]),t._v(" "),s("p",[t._v("当滚动条处于最大值时，指向最后一项，此时定位项为最后一项")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" itemCount "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" scrollTopMax "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" scrollHeight "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" clientHeight\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 进度条滚动百分比 */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" scrollPtg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" scrollTop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" scrollTopMax\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 确定定位项 */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" itemIndex "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("floor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scrollPtg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" itemCount"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 可见列表项个数 = 可见容器高度 / 每个列表项高度 ，记得向上取整 */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" visibleCount "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ceil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$el"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clientHeight "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("itemHeight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/** 确定起始项和结束项 */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startIndex "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" itemIndex "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ceil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scrollPtg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" visibleCount"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" endIndex "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("itemCount "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" itemIndex "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ceil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" scrollPtg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" visibleCount"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("h4",{attrs:{id:"_2-渲染列表项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-渲染列表项"}},[t._v("#")]),t._v(" ② 渲染列表项")]),t._v(" "),s("p",[t._v("渲染 startIndex ~ endIndex 的列表项")]),t._v(" "),s("h4",{attrs:{id:"_3-调整-offset"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-调整-offset"}},[t._v("#")]),t._v(" ③ 调整 offset")]),t._v(" "),s("p",[t._v("在列表项渲染完毕后，触发 update 回调")]),t._v(" "),s("p",[t._v("获取并统计 startIndex ~ itemIndex 列表项的实际总高度 s2iHeight")]),t._v(" "),s("p",[t._v("计算起始项偏移高度 startItemTop ,如下：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startItemTop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("定位项绝对高度")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("itemAbsoluteTop"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("起始项至定位项的高度")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s2iHeight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" itemAbsoluteTop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" scrollTop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("定位项相对视口高度")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("itemRelativeTop"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" itemRelativeTop "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("滚动过的视口高度")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scrollPtg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" clientHeight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("定位项偏移高度")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("itemOffsetPtg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" itemHeight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("如图所示：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://upload-images.jianshu.io/upload_images/9277731-629e103e1290b5c8.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"健壮-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#健壮-3"}},[t._v("#")]),t._v(" 健壮")]),t._v(" "),s("p",[s("strong",[t._v("由于总高度固定，不存在鼠标和滚动条不同步的问题")])]),t._v(" "),s("h3",{attrs:{id:"总结-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结-3"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("性能优异，通过几个数学公式即可确定起止位置（还有优化的空间）")]),t._v(" "),s("p",[t._v("若需要自适应高度，则需要进行2次render，否则第一次render即可计算偏移位置")]),t._v(" "),s("p",[t._v("目前"),s("strong",[t._v("唯一")]),t._v("一种不产生鼠标和滚动条不同步问题的方案")]),t._v(" "),s("p",[t._v("拓展性强，毕竟后面是 Ant Design 4 的核心组件之一")]),t._v(" "),s("p",[t._v("react 长列表首选方案")]),t._v(" "),s("p",[t._v("vue 可以尝试造个轮子")]),t._v(" "),s("h2",{attrs:{id:"其他处理方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他处理方案"}},[t._v("#")]),t._v(" 其他处理方案")]),t._v(" "),s("p",[t._v("本节为其他一些长列表的处理方案，主要表现在起始项查找和更新列表高度方面的不同")]),t._v(" "),s("p",[t._v("这里提到的几种方案，都会出现 "),s("em",[t._v("鼠标和滚动条不同步")]),t._v(" 的问题")]),t._v(" "),s("h3",{attrs:{id:"_1-顺序查找-差量更新总高度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-顺序查找-差量更新总高度"}},[t._v("#")]),t._v(" ① 顺序查找，差量更新总高度")]),t._v(" "),s("blockquote",[s("p",[t._v("性能较差的一种方案")])]),t._v(" "),s("p",[t._v("定义数组 itemHeightRecord 记录列表项实际高度，可以是自适应计算出来的高度，也可以是定义高度方法计算得到的高度")]),t._v(" "),s("p",[t._v("一开始，列表总高度 = 列表项个数 * 默认高度")]),t._v(" "),s("p",[t._v("查找起始项，由于没有记录偏移值，只能采用顺序叠加的方式判断， itemHeightRecord 中有值的取值，没值的取默认高度")]),t._v(" "),s("blockquote",[s("p",[t._v("时间复杂度 O(n)")])]),t._v(" "),s("p",[t._v("渲染列表项，并将取得的高度与默认值之间的差更新到 "),s("em",[t._v("列表总高度")]),t._v(" 上，并对 itemHeightRecord 进行赋值")]),t._v(" "),s("p",[s("em",[t._v("缺点：查找起始项的效率太低")])]),t._v(" "),s("h3",{attrs:{id:"_2-二分查找-顺序更新偏移值"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-二分查找-顺序更新偏移值"}},[t._v("#")]),t._v(" ② 二分查找，顺序更新偏移值")]),t._v(" "),s("p",[t._v("思路来源于 "),s("a",{attrs:{href:"https://juejin.im/post/5db684ddf265da4d495c40e5",target:"_blank",rel:"noopener noreferrer"}},[t._v("「前端进阶」高性能渲染十万条数据(虚拟列表)"),s("OutboundLink")],1),t._v(" ，并对更新偏移值进行优化")]),t._v(" "),s("p",[t._v("需要配置数据项最小高度，并根据这个值初始化每个数据项的高度和偏移值 -- sizes")]),t._v(" "),s("p",[t._v("列表总高度 = "),s("code",[t._v("sizes[length-1].offset + sizes[length-1].height")])]),t._v(" "),s("p",[t._v("查找起始项，根据 sizes 进行二分")]),t._v(" "),s("blockquote",[s("p",[t._v("时间复杂度 O(logn)")])]),t._v(" "),s("p",[t._v("渲染列表项(假设有m项)，并将取得的高度替换 sizes 中的 height，并将 height 与默认值之间的差更新到其后每一项的 offset")]),t._v(" "),s("blockquote",[s("p",[t._v("时间复杂度 O(n)")])]),t._v(" "),s("p",[t._v("与 vue-virtual-scroller 自适应高度的处理方式类似，只不过我们仅需要从起始项开始处理")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://codesandbox.io/s/virtuallist-3-i3h9v",target:"_blank",rel:"noopener noreferrer"}},[t._v("在线 Demo"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("引用自 「前端进阶」高性能渲染十万条数据(虚拟列表) ，更新偏移值那边的时间复杂度为 O(n*m)")])]),t._v(" "),s("p",[s("em",[t._v("缺点：更新 sizes 较为耗时")])]),t._v(" "),s("h3",{attrs:{id:"_3-树状数组优化更新偏移值"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-树状数组优化更新偏移值"}},[t._v("#")]),t._v(" ③ 树状数组优化更新偏移值")]),t._v(" "),s("p",[t._v("自己想出来的一种解决方案，能够达到查询和更新都是 "),s("code",[t._v("O(logn)")]),t._v(" 时间复杂度")]),t._v(" "),s("p",[t._v("在未看 "),s("a",{attrs:{href:"https://github.com/react-component/virtual-list",target:"_blank",rel:"noopener noreferrer"}},[t._v("virtual-list"),s("OutboundLink")],1),t._v(" 的方案前，我一度以为这是最好的方案")]),t._v(" "),s("blockquote",[s("p",[t._v("效率上两者差不多，不过本方案会有 "),s("em",[t._v("鼠标和滚动条不同步")]),t._v(" 的问题")])]),t._v(" "),s("p",[t._v("我们先建立数据模型，列表项的高度列表为长度为 len 的正数数组 nums ，有两种操作：")]),t._v(" "),s("ol",[s("li",[t._v("更新数组中某项的值")]),t._v(" "),s("li",[t._v("找到一个最小的 n，前 n 项总和大于等于目标值 target ， 1<= n <= len")])]),t._v(" "),s("p",[t._v("很明显这是一个树状数组模板题，两个操作都是 O(logn) 的时间复杂度，模板可以参考我写的 "),s("a",{attrs:{href:"https://github.com/francecil/LearningWeb/blob/master/source/_posts/%E7%AE%97%E6%B3%95%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/%E5%9F%BA%E7%A1%80%E6%A8%A1%E6%9D%BF.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("BinaryIndexedTree"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("关于树状数组原理可以参考文章 -- "),s("a",{attrs:{href:"http://hawstein.com/2012/11/15/binary-indexed-trees/",target:"_blank",rel:"noopener noreferrer"}},[t._v("树状数组(Binary Indexed Trees)"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("提供了几个方法")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findGe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("target")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//找到最小的一个n，其前n项和大于等于 target")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" val")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 第 i 项增加差值val, 1<=i<=len")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("prefixSum")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("n "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//计算前 n 项的和 , 1<=n<=len")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("查找起始项可以采用 findGe, 查找起始项偏移位置以及列表总高度可以用 prefixSum, 更新偏移值采用 update")]),t._v(" "),s("p",[t._v("测试效果：10W 条数据滚动时处理的计算时间在 1ms 左右")]),t._v(" "),s("p",[t._v("感兴趣的可以看我的开源库 "),s("a",{attrs:{href:"https://github.com/francecil/virtual-list-demo",target:"_blank",rel:"noopener noreferrer"}},[t._v("virtual-list-demo"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"回流优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#回流优化"}},[t._v("#")]),t._v(" 回流优化")]),t._v(" "),s("p",[t._v("可视区域的列表高度，一般不变，没必要每次都通过 "),s("code",[t._v("$el.clientHeight")]),t._v(" 获取（会造成回流），在 resize 时再改变")]),t._v(" "),s("p",[t._v("如果是自适应高度，那本操作可有可无")]),t._v(" "),s("h2",{attrs:{id:"综合实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#综合实现"}},[t._v("#")]),t._v(" 综合实现")]),t._v(" "),s("p",[t._v("本来打算单独写一节的，最后决定采用 virtual-list 的设计方式")]),t._v(" "),s("p",[t._v("列表项采用 "),s("code",[t._v("Render Props")]),t._v(" 的形式，用 cloneElement 生成实际列表项。")]),t._v(" "),s("p",[t._v("无论是自适应高度还是固定高度，都是通过参数配置，对外仅提供一个组件")]),t._v(" "),s("h2",{attrs:{id:"展望"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#展望"}},[t._v("#")]),t._v(" 展望")]),t._v(" "),s("h3",{attrs:{id:"浏览器兼容性测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#浏览器兼容性测试"}},[t._v("#")]),t._v(" 浏览器兼容性测试")]),t._v(" "),s("p",[t._v("个人方案仅测试了 chrome ，还没测试过其他浏览器，看开源库的时候有看到其做了一些兼容处理")]),t._v(" "),s("p",[t._v("比如火狐滚动白屏问题，Safari scrollTop 可能为负的问题，移动端卡顿的问题")]),t._v(" "),s("p",[t._v("篇幅有限，这些不在本文的研究范围，建议就是生产环境尽量用开源库")]),t._v(" "),s("h3",{attrs:{id:"图片自适应高度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#图片自适应高度"}},[t._v("#")]),t._v(" 图片自适应高度")]),t._v(" "),s("p",[t._v("若列表项高度是依赖于图片高度的，由于图片加载较慢，在初次渲染结束时（update生命周期中）并获取不到真实列表高度，需要等待图片加载完毕后计算")]),t._v(" "),s("p",[t._v("具体做法就是采用 ResizeObserver API ，不过这个兼容性有点问题，")]),t._v(" "),s("p",[t._v("vue-virtual-scroller 中其实有用到了，感兴趣的可以参考一下")]),t._v(" "),s("h3",{attrs:{id:"响应键盘事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#响应键盘事件"}},[t._v("#")]),t._v(" 响应键盘事件")]),t._v(" "),s("p",[t._v("通过方向键切换列表项，需要拦截键盘默认事件，并赋值 scrollTop")]),t._v(" "),s("p",[t._v("这个更多的是基于长列表的 Select,Tree 中会用到，到时候用到再说")]),t._v(" "),s("hr"),t._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/francecil/LearningWeb/blob/master/source/_posts/2019Q4/%E5%89%8D%E7%AB%AF%E9%95%BF%E5%88%97%E8%A1%A8%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BC%98%E5%8C%96.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("原文地址"),s("OutboundLink")],1),t._v("，感兴趣的给个 star ~")]),t._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),s("ol",[s("li",[s("a",{attrs:{href:"https://github.com/ChuChencheng/virtual-list-demo",target:"_blank",rel:"noopener noreferrer"}},[t._v("virtual-list-demo"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.im/post/5db684ddf265da4d495c40e5",target:"_blank",rel:"noopener noreferrer"}},[t._v("「前端进阶」高性能渲染十万条数据(虚拟列表)"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/34585166",target:"_blank",rel:"noopener noreferrer"}},[t._v("再谈前端虚拟列表的实现"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);