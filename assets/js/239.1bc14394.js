(window.webpackJsonp=window.webpackJsonp||[]).push([[239],{1019:function(s,t,a){"use strict";a.r(t);var n=a(30),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("之前写了一篇长列表实现的分享 -- "),t("a",{attrs:{href:"https://juejin.im/post/5dea86f7f265da33a8758820",target:"_blank",rel:"noopener noreferrer"}},[s._v("「前端长列表」开源库解析及最佳实践"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("然后面试被问到的最多的问题就是：有没有做节流")]),s._v(" "),t("p",[s._v("当时的回答是没有，但是又说不出一个系统的回答")]),s._v(" "),t("p",[s._v("本文就来说说为什么长列表不需要做节流，以及什么情况下滚动需要做节流")]),s._v(" "),t("h2",{attrs:{id:"背景知识之事件循环"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景知识之事件循环"}},[s._v("#")]),s._v(" 背景知识之事件循环")]),s._v(" "),t("p",[s._v("详见"),t("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#event-loops",target:"_blank",rel:"noopener noreferrer"}},[s._v("HTML规范"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("这里只挑与本文相关的讲")]),s._v(" "),t("p",[s._v("在事件循环中定义了很多任务源，比如鼠标键盘等输入操作的用户交互任务源")]),s._v(" "),t("p",[s._v("一次点击操作，其实包含多个输入操作（mousedown,mouseup,click），都添加到相同的任务源队列中，进而产生多轮的事件循环，其表现就是执行相关元素的事件回调（宏任务）")]),s._v(" "),t("p",[s._v("宏任务执行后，后面就是微任务队列和更新渲染阶段")]),s._v(" "),t("p",[s._v("每轮事件循环可能是非常快的，每秒执行事件循环的次数可能大于60次")]),s._v(" "),t("p",[s._v("受硬件刷新率影响，我们只要保证 fps 达到最大硬件刷新率(比如60)即可，因此不需要每轮事件循环都更新渲染")]),s._v(" "),t("h2",{attrs:{id:"输入事件与滚动事件的执行时机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#输入事件与滚动事件的执行时机"}},[s._v("#")]),s._v(" 输入事件与滚动事件的执行时机")]),s._v(" "),t("p",[s._v("对于输入事件，其执行时机为每轮事件循环的任务执行阶段，这个事件是不受刷新率影响的，每秒的执行次数可能多于60次")]),s._v(" "),t("p",[s._v("为什么谈这个呢，因为这个与滚动事件(scroll)回调的执行时机不一致")]),s._v(" "),t("p",[s._v("按照 HTML 规范，滚动事件回调在 UI Render 阶段的某个步骤中进行，而不是单独的一个任务源")]),s._v(" "),t("p",[s._v("也就是说，滚动事件回调受渲染时机影响，仅执行更新渲染时才执行该回调。")]),s._v(" "),t("p",[s._v("换句话说，该事件自带节流。")]),s._v(" "),t("p",[s._v("举个例子验证下输入事件和更新渲染的执行时机")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("document"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addEventListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mousemove"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" start "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" performance"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mousemove:"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("requestAnimationFrame")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("t")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ui render:"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 结果就是可能输出几轮 mousemove 然后执行一次 ui render -- 清空 rAF 回调队列(输出多次 ui render)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\nmousemove: 4091.025000088848\nui render: 4091.025000088848 4077.594\nmousemove: 4098.845000029542\nui render: 4098.845000029542 4094.278\nmousemove: 4110.160000040196\nmousemove: 4115.5349999899045\nui render: 4110.160000040196 4110.962\nui render: 4115.5349999899045 4110.962\nmousemove: 4123.810000019148\nmousemove: 4130.160000058822\nui render: 4123.810000019148 4127.719\nui render: 4130.160000058822 4127.719\n*/")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("说明更新渲染有一定的间隔，至少是 1/60 的间隔，而输入任务没有此限制")]),s._v(" "),t("p",[s._v("所以，以下代码是没有效果的，因为该回调已经自带节流了")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("document"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addEventListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"scroll"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("e")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("requestAnimationFrame")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("t")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//执行scroll具体逻辑")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"什么时候滚动需要做节流"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么时候滚动需要做节流"}},[s._v("#")]),s._v(" 什么时候滚动需要做节流")]),s._v(" "),t("p",[s._v("利用节流可以减少回调的执行次数，使得固定时间周期内只执行一次")]),s._v(" "),t("p",[s._v("刚才提到，滚动事件自带节流，节流的时间周期是与渲染时机相关")]),s._v(" "),t("p",[s._v("判断是否需要额外的节流的关键是：当前的节流规则，是否大部分回调的执行都能让用户受益")]),s._v(" "),t("p",[s._v("如果是动画效果，实时绘制的界面等，则不需要额外的节流了。")]),s._v(" "),t("p",[s._v("以长列表为例，每次执行滚动回调，会计算新的渲染列表项及滚动偏移位置。如果应用更大时间周期的节流，会出现某一帧出现滚动但界面没有更新的情况，让用户感觉产生卡顿。")]),s._v(" "),t("p",[s._v("而其他比较复杂的业务逻辑，不能在短时间内得到反馈的，则需要额外进行节流")]),s._v(" "),t("p",[s._v("以滚动懒加载图片为例")]),s._v(" "),t("p",[s._v("由于每秒的滚动回调的执行次数可能达到60次，而每次执行都需要去获取当前处于视区的占位图并发起图片请求")]),s._v(" "),t("p",[s._v("而这大部分回调的执行，用户是不能受益的，所以我们可以提高节流的时间周期，比如 500ms 这样")]),s._v(" "),t("h2",{attrs:{id:"结论"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),t("p",[s._v("滚动事件已自带节流，只有一些特定的业务逻辑才需要额外进行更高时间周期的节流")]),s._v(" "),t("h2",{attrs:{id:"拓展阅读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#拓展阅读"}},[s._v("#")]),s._v(" 拓展阅读")]),s._v(" "),t("ol",[t("li",[t("a",{attrs:{href:"https://stackoverflow.com/questions/41740082/scroll-events-requestanimationframe-vs-requestidlecallback-vs-passive-event-lis",target:"_blank",rel:"noopener noreferrer"}},[s._v("scroll events: requestAnimationFrame VS requestIdleCallback VS passive event listeners"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);