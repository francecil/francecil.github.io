(window.webpackJsonp=window.webpackJsonp||[]).push([[157],{894:function(a,e,s){"use strict";s.r(e);var n=s(27),r=Object(n.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("p",[a._v("https://mp.weixin.qq.com/s/PIdmJ2cHmq9QBj6MBJ9ygQ")]),a._v(" "),e("h2",{attrs:{id:"使用-yarn-workspace-时的踩坑记录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-yarn-workspace-时的踩坑记录"}},[a._v("#")]),a._v(" 使用 yarn + workspace 时的踩坑记录")]),a._v(" "),e("p",[a._v("背景：一个 yarn + workspace 的项目，里面包含了一些工具包和业务包（ts构建）；工具包可以对外发布，也可以由业务包引用；\n希望达到的效果：运行业务包时，采用源码引用的方式引用工具包，避免改动工具包代码还得重新构建或者新开终端去进行热更新。想到的实现方式有：业务包里面直接引入工具包源码路径，或者配置下 alias\n但是网上说这个方式很精分，包不像包源码不像源码。关于这个你怎么看？")]),a._v(" "),e("blockquote",[e("p",[a._v("后续决定就当成纯粹的包，仅采用产物引用方式")])]),a._v(" "),e("p",[a._v("如果想当其为纯粹的包，采用产物引用的方式去引用工具包（业务包里面引入的是工具包的编译产物）；但这种方式就有一个包提前构建的环节，新同学下载项目用跑业务包，还需要先把工具包编译下。想到的解决方案是监听 install 钩子，编写脚本去编译工具包。感觉还是有点麻烦，我看你们的 pnpm monorepo 有个 prepare 钩子，试了下 yarn workspace 的好像不能生效。")]),a._v(" "),e("blockquote",[e("p",[a._v("自己去写脚本进行 build 是有问题的。可能子包之间是有依赖关系的；自己去做依赖分析是不靠谱的，而 lerna 帮忙做了这个处理\n可以看这个 issue 的讨论 https://github.com/yarnpkg/yarn/issues/3911\ninstall 的时候会触发顶层 monorepo 的 prepare 脚本，此时再调用 "),e("code",[a._v("lerna run prepare")]),a._v(" （不要用 yarn 的），那么子仓库有该脚本的都会去执行")])]),a._v(" "),e("p",[a._v("如果也做了预先打包，那远程仓库代码变更，本地拉取后由于未重新打包，可能会存在一些问题（比如本地测试认为没问题了，但实际上线是不一致的）。关于这块有什么建议不？")]),a._v(" "),e("blockquote",[e("p",[a._v("改成业务启动调试时，通过 "),e("code",[a._v("lerna run --sort compile")]),a._v(" 命令对通用包进行编译")])]),a._v(" "),e("h3",{attrs:{id:"推荐方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#推荐方案"}},[a._v("#")]),a._v(" 推荐方案")]),a._v(" "),e("p",[a._v("顶部配置")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('"dev": "npm run compile && lerna run --parallel dev --max-buffer 99999999",\n"compile": "lerna run --sort compile",\n\n// 子包配置 \n"compile": "yarn build",\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br")])]),e("h2",{attrs:{id:"node-monorepo-实践"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#node-monorepo-实践"}},[a._v("#")]),a._v(" node monorepo 实践")]),a._v(" "),e("p",[a._v("https://juejin.cn/post/6983908579904323598")]),a._v(" "),e("h3",{attrs:{id:"方案-业务-package-打包时取消-monorepo-特性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案-业务-package-打包时取消-monorepo-特性"}},[a._v("#")]),a._v(" 方案：业务 package 打包时取消 monorepo 特性")]),a._v(" "),e("ol",[e("li",[a._v("将项目 yarn.lock 文件复制至业务 package")]),a._v(" "),e("li",[a._v("删除项目根目录的 "),e("code",[a._v("package.json")]),a._v(" 文件，取消 yarn monorepo 状态")]),a._v(" "),e("li",[a._v("业务 package 开始安装依赖")]),a._v(" "),e("li",[a._v("业务 package 执行打包指令")])]),a._v(" "),e("p",[a._v("缺点：？")]),a._v(" "),e("h3",{attrs:{id:"方案-通用-package-发包-业务-package-安装已发包的-通用-package-依赖"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案-通用-package-发包-业务-package-安装已发包的-通用-package-依赖"}},[a._v("#")]),a._v(" 方案：通用 package 发包 + 业务 package 安装已发包的 通用 package 依赖")]),a._v(" "),e("p",[a._v("在顶层 "),e("code",[a._v("yarn install")]),a._v(" 之后，还需要进入对应业务 package 执行添加通用 package 的指令")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[a._v("lerna "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--scope")]),a._v(" @biz-project/server "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n-- "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" @me/lib-common\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br")])]),e("p",[a._v("缺点：")]),a._v(" "),e("ul",[e("li",[a._v("只能绑定 npm 包版本")]),a._v(" "),e("li",[a._v("打包脚本难以维护")])]),a._v(" "),e("h3",{attrs:{id:"方案-通用-package-打包-并转移至业务-package-的-node-modules-中"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案-通用-package-打包-并转移至业务-package-的-node-modules-中"}},[a._v("#")]),a._v(" 方案：通用 package 打包，并转移至业务 package 的 node_modules 中")]),a._v(" "),e("p",[a._v("yarn-workspace-isolator")]),a._v(" "),e("h2",{attrs:{id:"子-package-安装不同版本-顶部-yarn-lock-是怎么组织的"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#子-package-安装不同版本-顶部-yarn-lock-是怎么组织的"}},[a._v("#")]),a._v(" 子 package 安装不同版本，顶部 yarn.lock 是怎么组织的？")]),a._v(" "),e("h2",{attrs:{id:"monorepo-node-测试仓库-带各种环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#monorepo-node-测试仓库-带各种环境"}},[a._v("#")]),a._v(" Monorepo-node 测试仓库，带各种环境")]),a._v(" "),e("h2",{attrs:{id:"lerna-指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#lerna-指令"}},[a._v("#")]),a._v(" lerna 指令")]),a._v(" "),e("p",[a._v("http://www.febeacon.com/lerna-docs-zh-cn/routes/commands/")]),a._v(" "),e("p",[a._v("lerna clean:\t从所有包中删除node_modules目录")]),a._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 删除除了 @p/a 包之外其他包的 node_modules")]),a._v("\nlerna clean "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--ignore")]),a._v(" @p/a "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--yes")]),a._v("\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br")])]),e("p",[a._v("lerna publish 发包，会记录")]),a._v(" "),e("p",[a._v("lerna 发包原理：")]),a._v(" "),e("ul",[e("li",[a._v("https://zhuanlan.zhihu.com/p/392438222")])])])}),[],!1,null,null,null);e.default=r.exports}}]);