(window.webpackJsonp=window.webpackJsonp||[]).push([[287],{1179:function(t,a,s){"use strict";s.r(a);var n=s(30),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("接上文 "),a("a",{attrs:{href:"https://juejin.im/post/5e64f811e51d4526e807fefa",target:"_blank",rel:"noopener noreferrer"}},[t._v("面试官问：什么是 canvas 污染"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("本文仅讨论 Canvas 2D")]),t._v(" "),a("p",[t._v("网上这类的文章已经很多了，本文仅仅是一个记录与总结。")]),t._v(" "),a("p",[t._v("推荐文末的拓展阅读")]),t._v(" "),a("h1",{attrs:{id:"性能分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#性能分析"}},[t._v("#")]),t._v(" 性能分析")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/canvas.html#the-canvas-element",target:"_blank",rel:"noopener noreferrer"}},[t._v("Canvas 规范"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("渲染也是在 UI Render 中进行")]),t._v(" "),a("p",[t._v("context 是一个状态栈")]),t._v(" "),a("p",[t._v("状态包括")]),t._v(" "),a("ul",[a("li",[t._v("当前应用的变形")]),t._v(" "),a("li",[t._v("strokeStyle, fillStyle, globalAlpha, lineWidth, lineCap, lineJoin, miterLimit, shadowOffsetX, shadowOffsetY, shadowBlur, shadowColor, globalCompositeOperation 的值")]),t._v(" "),a("li",[t._v("当前的裁切路径（clipping path）")])]),t._v(" "),a("h1",{attrs:{id:"优化策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化策略"}},[t._v("#")]),t._v(" 优化策略")]),t._v(" "),a("h2",{attrs:{id:"分层绘制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分层绘制"}},[t._v("#")]),t._v(" 分层绘制")]),t._v(" "),a("p",[t._v("单一清除策略，适合同层物体矩形框不重叠的情况")]),t._v(" "),a("p",[t._v("如果同层2个物体重叠，上一策略在清除时会清掉另一物体的部分像素。")]),t._v(" "),a("p",[t._v("此时应该判断两者是否重叠，若重叠两者合并得到一个脏矩形，清空脏矩形，并重绘两个物体")]),t._v(" "),a("p",[t._v("更具体的细节可以查看 "),a("a",{attrs:{href:"https://www.ibm.com/developerworks/cn/web/wa-canvashtml5layering/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("利用分层优化 HTML5 画布渲染"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"通过计算避免无效绘制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过计算避免无效绘制"}},[t._v("#")]),t._v(" 通过计算避免无效绘制")]),t._v(" "),a("p",[t._v("通过计算判断所绘制元素可见与否，是否需要绘制")]),t._v(" "),a("p",[t._v("计算性能与渲染性能的平衡")]),t._v(" "),a("h2",{attrs:{id:"离屏绘制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#离屏绘制"}},[t._v("#")]),t._v(" 离屏绘制")]),t._v(" "),a("p",[t._v("将常用图像绘制在另一个 canvas 中")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在离屏 canvas 上绘制")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" canvasOffscreen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'canvas'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ncanvasOffscreen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("width "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ncanvasOffscreen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("height "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ncanvasOffscreen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2d'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("drawImage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("image"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在绘制每一帧的时候，绘制这个图形")]),t._v("\ncontext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("drawImage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("canvasOffscreen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" y"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("blockquote",[a("p",[t._v("摘自 《Canvas 最佳实践（性能篇）》")])]),t._v(" "),a("p",[t._v("还可以借助 worker 进行优化")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// main.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" offscreenCanvas "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transferControlToOffscreen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("postMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("offscreenCanvas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("offscreenCanvas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// worker.js ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pos "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("draw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("dt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearRect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fillRect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  pos "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" dt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestAnimationFrame")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("draw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nself"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onmessage")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ev")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" transferredCanvas "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ev"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ctx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" transferredCanvas"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getContext")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2d"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("draw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])]),a("blockquote",[a("p",[t._v("引自 https://html.spec.whatwg.org/multipage/imagebitmap-and-animations.html#animation-frames")])]),t._v(" "),a("h2",{attrs:{id:"合理使用-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#合理使用-api"}},[t._v("#")]),t._v(" 合理使用 API")]),t._v(" "),a("p",[t._v("减少耗时 api 的使用")]),t._v(" "),a("p",[t._v("减少改变 context 的状态")]),t._v(" "),a("p",[t._v("避免非法赋值")]),t._v(" "),a("h2",{attrs:{id:"可交互画布"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可交互画布"}},[t._v("#")]),t._v(" 可交互画布")]),t._v(" "),a("h3",{attrs:{id:"判断点的位置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#判断点的位置"}},[t._v("#")]),t._v(" 判断点的位置")]),t._v(" "),a("p",[a("code",[t._v("ctx.isPointInPath")])]),t._v(" "),a("p",[t._v("使用 isPointinPath 方法检查某点是否在当前路径 path (Path2D) 内")]),t._v(" "),a("p",[t._v("但很多情况下我们没有保存这个 path ，此时自己采用射线法计算判断")]),t._v(" "),a("h3",{attrs:{id:"获取点击区域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取点击区域"}},[t._v("#")]),t._v(" 获取点击区域")]),t._v(" "),a("p",[t._v("addHitRegion")]),t._v(" "),a("p",[t._v("有兼容性问题， Safari 等不支持")]),t._v(" "),a("h3",{attrs:{id:"避免使用-canvas-实现文本编辑控件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#避免使用-canvas-实现文本编辑控件"}},[t._v("#")]),t._v(" 避免使用 canvas 实现文本编辑控件")]),t._v(" "),a("p",[t._v("这个不用说了， canvas 难以实现")]),t._v(" "),a("p",[t._v("参照 "),a("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/canvas.html#best-practices",target:"_blank",rel:"noopener noreferrer"}},[t._v("Best practices"),a("OutboundLink")],1)]),t._v(" "),a("h1",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("ol",[a("li",[t._v("将渲染开销转嫁到计算开销")]),t._v(" "),a("li",[t._v("利用分层渲染复杂场景")]),t._v(" "),a("li",[t._v("固定内容采用离屏渲染")]),t._v(" "),a("li",[t._v("合理使用 API 并管理状态")])]),t._v(" "),a("h1",{attrs:{id:"拓展阅读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#拓展阅读"}},[t._v("#")]),t._v(" 拓展阅读")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.ibm.com/developerworks/cn/web/wa-canvashtml5layering/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("利用分层优化 HTML5 画布渲染"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://fed.taobao.org/blog/taofed/do71ct/canvas-performance/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Canvas 最佳实践（性能篇）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas",target:"_blank",rel:"noopener noreferrer"}},[t._v("canvas的优化"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);