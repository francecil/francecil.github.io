(window.webpackJsonp=window.webpackJsonp||[]).push([[184],{966:function(t,s,a){"use strict";a.r(s);var e=a(30),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("Babel 是什么？")]),t._v(" "),s("blockquote",[s("p",[t._v("Babel 是将我们写的 ES6+ 代码，包括"),s("code",[t._v("语法层（比如 let、class）")]),t._v(" 和 "),s("code",[t._v("api 层（比如 Promise、Array.prototype.flat ）")]),t._v("，转换为向后兼容的代码的工具")])]),t._v(" "),s("p",[t._v("在使用 Babel 的过程中，或多或少会有这些疑问：")]),t._v(" "),s("ol",[s("li",[t._v("Babel 怎么用？它有哪些主要模块？")]),t._v(" "),s("li",[t._v("Babel 与 webpack 什么关系？如何单独使用 Babel？如何处理第三方依赖的？")]),t._v(" "),s("li",[t._v("Babel 与 TypeScript 是怎么配合的？")])]),t._v(" "),s("p",[t._v("我们带着这些问题开始本文~")]),t._v(" "),s("h1",{attrs:{id:"babel-的组成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#babel-的组成"}},[t._v("#")]),t._v(" Babel 的组成")]),t._v(" "),s("ul",[s("li",[t._v("@babel/preset-env")]),t._v(" "),s("li",[t._v("@babel/plugin-transform-runtime")])]),t._v(" "),s("h2",{attrs:{id:"babel-preset-env"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#babel-preset-env"}},[t._v("#")]),t._v(" @babel/preset-env")]),t._v(" "),s("blockquote",[s("p",[t._v("详见官方文档：https://babeljs.io/docs/babel-preset-env")])]),t._v(" "),s("p",[t._v("智能预设，以供项目使用最新的 JavaScript ，包括语法以及"),s("strong",[t._v("可选的 api polyfill")]),t._v("。")]),t._v(" "),s("p",[t._v("包含三个关键配置：")]),t._v(" "),s("ul",[s("li",[t._v("targets: 指定目标浏览器环境配置，表示这些语法和 polyfill 需要在目标浏览器上可以无错运行。实际项目推荐使用 .browserslistrc 文件配置")]),t._v(" "),s("li",[t._v("useBuiltIns: 配置 polyfill 导入策略，包括：\n"),s("ul",[s("li",[t._v("false：不引入 polyfill，只转语法，默认值")]),t._v(" "),s("li",[t._v("entry：全量导入，严格来说，是导入 targets 所需 polyfill。\n"),s("ul",[s("li",[t._v("使用：除了配置外，还需要入口文件引入 "),s("code",[t._v("core-js")])]),t._v(" "),s("li",[t._v("缺点：包体积较大")]),t._v(" "),s("li",[t._v("优点：可以避免第三方包没有处理 polyfill 或者处理不当，导致引用异常")])])]),t._v(" "),s("li",[t._v("usage：按需导入。\n"),s("ul",[s("li",[t._v("使用：配置即可，无需手动引用模块，babel 会根据用户代码自动导入 polyfill")]),t._v(" "),s("li",[t._v("优点：按需导入包体积较小")]),t._v(" "),s("li",[t._v("缺点：无法处理第三方包的 polyfill 问题")]),t._v(" "),s("li",[t._v("注意：按需引入时，如果无法确定具体的原型方法，则都导入。比如 "),s("code",[t._v("t.includes")]),t._v(" 这段代码，不知道是 string 还是 array ，babel 会都导入")])])])])]),t._v(" "),s("li",[t._v("corejs：配置 corejs 的版本，是否使用提案特性（proposals）")])]),t._v(" "),s("h2",{attrs:{id:"babel-plugin-transform-runtime"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#babel-plugin-transform-runtime"}},[t._v("#")]),t._v(" @babel/plugin-transform-runtime")]),t._v(" "),s("blockquote",[s("p",[t._v("详见官方文档：https://babeljs.io/docs/babel-plugin-transform-runtime")])]),t._v(" "),s("p",[t._v("该插件主要为库开发而生，有两个特点：")]),t._v(" "),s("ol",[s("li",[t._v("为待 polyfill 的 api 创建沙盒环境，避免污染全局范围：比如库中使用了 Promise ，与外部项目的 Promise Polyfill 不兼容，那么就可以利用该插件给库用到的 Promise 进行沙盒转换，同时不影响外部的 Promise Polyfill")]),t._v(" "),s("li",[t._v("引用模块 "),s("code",[t._v("@babel/runtime")]),t._v(" 以避免编译重复输出：减少包体积")])]),t._v(" "),s("p",[t._v("然而，大多数第三方包并没有做 "),s("code",[t._v("transform-runtime")]),t._v(" 这个处理，主要有两个原因：")]),t._v(" "),s("ol",[s("li",[t._v("导致产物体积变大")]),t._v(" "),s("li",[t._v("三方包并不知道外部项目的目标环境，不知道哪些该转")])]),t._v(" "),s("p",[t._v("因此，第三方包一般只转语法，不转 api 。\n同时，大家都约定所用语法基于标准，仅当库所用 api 非标准时才自行加 runtime Polyfill。")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("ul",[s("li",[t._v("库一般不需要提供补丁，始终由应用方统一提供即可。")]),t._v(" "),s("li",[t._v("应用补丁，使用 @babel/preset-env + useBuiltIns ，根据兼容目标自动获取补丁")])]),t._v(" "),s("h1",{attrs:{id:"babel-与-webpack"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#babel-与-webpack"}},[t._v("#")]),t._v(" Babel 与 webpack")]),t._v(" "),s("p",[t._v("现在的项目中，好像用 Babel 的时候就得带上 webpack ，实际上不是的。")]),t._v(" "),s("p",[t._v("如果项目已经采用 webpack 等构建工具, 那么可以选择使用 babel-loader ，内部会获取文件内容并调用 "),s("code",[t._v("@babel/core")]),t._v(" 进行转换")]),t._v(" "),s("blockquote",[s("p",[t._v("推荐 babel 配置用 "),s("code",[t._v("babel.config.js")]),t._v(" 维护，打包配置用 webpack 维护")])]),t._v(" "),s("p",[t._v("如果不是标准项目，仅仅只是为了转换，那么可以选择使用 babel 命令")]),t._v(" "),s("blockquote",[s("p",[t._v("详见：https://babeljs.io/docs/usage")])]),t._v(" "),s("h2",{attrs:{id:"示例-babel-项目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例-babel-项目"}},[t._v("#")]),t._v(" 示例 Babel 项目")]),t._v(" "),s("ol",[s("li",[t._v("安装依赖")])]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("yarn")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--dev")]),t._v(" @babel/core @babel/cli @babel/preset-env\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("配置 babel")])]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("presets")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@babel/preset-env"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("targets")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("edge")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"17"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("firefox")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"60"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("chrome")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"67"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("safari")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"11.1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ie")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"11"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useBuiltIns")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"usage"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("corejs")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3.6.5"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[t._v("编写代码，并执行命令转换")])]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将 src 目录下的 js 文件进行转换，并输出到 lib 目录")]),t._v("\n./node_modules/.bin/babel src --out-dir lib\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h2",{attrs:{id:"babel-与第三方依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#babel-与第三方依赖"}},[t._v("#")]),t._v(" Babel 与第三方依赖")]),t._v(" "),s("p",[t._v("babel 只处理单文件，因此如果要转译第三方依赖，以及其他文件，就需要用到打包器（比如 webpack）")]),t._v(" "),s("p",[t._v("注意 core-js 的代码逻辑，除了引入 "),s("code",[t._v("core-js/modules")]),t._v(" 的代码，还会引入众多 "),s("code",[t._v("core-js/internals")]),t._v(" 工具代码（这部分代码量还是挺多的）。")]),t._v(" "),s("h2",{attrs:{id:"将第三方依赖进行-babel-处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#将第三方依赖进行-babel-处理"}},[t._v("#")]),t._v(" 将第三方依赖进行 babel 处理")]),t._v(" "),s("p",[t._v("默认情况下不对第三方依赖进行处理 "),s("strong",[t._v("（包括语法转译）")]),t._v(" ，即 exclude /node_modules/ 。")]),t._v(" "),s("p",[t._v("如果想要 babel 处理第三方模块，需要修改 exclude 逻辑：")]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exclude")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("path")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("node_modules")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("@gahing\\/test-pkg")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h1",{attrs:{id:"babel-与-typescript"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#babel-与-typescript"}},[t._v("#")]),t._v(" Babel 与 TypeScript")]),t._v(" "),s("p",[t._v("对于 typescript 项目，编译采用 tsc 还是 babel？")]),t._v(" "),s("p",[t._v("直接说结论：")]),t._v(" "),s("ul",[s("li",[t._v("大部分项目用 tsc 足以，支持语法转译，polyfill 可以走 core-js 全量引入，担心体积太大可以用 "),s("code",[t._v("polyfill.io")]),t._v(" 这类在线方案")]),t._v(" "),s("li",[t._v("有草案阶段语法诉求，可以升级 tsc 版本实现支持；当然也可以走 babel 方案编译")]),t._v(" "),s("li",[t._v("如果走 babel 方案编译，需要注意 babel 主要针对单文件处理，部分 ts 语法无法正常转换")])]),t._v(" "),s("p",[t._v("更多细节可以看以下文章：")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://blog.logrocket.com/babel-vs-typescript-choosing-right-compiler-project/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Babel vs. TypeScript: Choosing the right compiler for your project"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.cn/post/7084882650233569317",target:"_blank",rel:"noopener noreferrer"}},[t._v("编译 ts 代码用 tsc 还是 babel？"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.cn/post/6968636129239105549",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么说用 babel 编译 typescript 是更好的选择"),s("OutboundLink")],1)])]),t._v(" "),s("h1",{attrs:{id:"常见问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常见问题"}},[t._v("#")]),t._v(" 常见问题")]),t._v(" "),s("h2",{attrs:{id:"q-为什么通常不对第三方依赖做-babel-处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q-为什么通常不对第三方依赖做-babel-处理"}},[t._v("#")]),t._v(" Q：为什么通常不对第三方依赖做 babel 处理？")]),t._v(" "),s("p",[t._v("有以下原因：")]),t._v(" "),s("ol",[s("li",[t._v("避免增大包体积(重点)以及较长的构建时间。")]),t._v(" "),s("li",[t._v("社区约定俗成，打包产物需要转成 es5。")]),t._v(" "),s("li",[t._v("大多数业务对浏览器兼容性诉求没那么高")])]),t._v(" "),s("p",[t._v("如果担心的话，可以对第三方依赖做 babel 处理。此外也可以通过一些白屏检测方案来保证不会出问题。")]),t._v(" "),s("h2",{attrs:{id:"q-如果第三方依赖没有转译-es5-webpack-打包时默认会处理么-会出现什么问题-怎么解决"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q-如果第三方依赖没有转译-es5-webpack-打包时默认会处理么-会出现什么问题-怎么解决"}},[t._v("#")]),t._v(" Q: 如果第三方依赖没有转译 es5，webpack 打包时默认会处理么？会出现什么问题？怎么解决？")]),t._v(" "),s("p",[t._v("基本不会。")]),t._v(" "),s("blockquote",[s("p",[t._v("webpack 打包时配置 target 为 "),s("code",[t._v("['web','es5']")]),t._v("，只会影响包裹代码和代码压缩逻辑。压缩过程中有可能会转换语法，但大多数情况下不会。")])]),t._v(" "),s("ul",[s("li",[t._v("导致的问题：低版本浏览器解析报错甚至白屏。")]),t._v(" "),s("li",[t._v("解决方案：可以将该包加入 babel 编译")])]),t._v(" "),s("p",[t._v("详见这两个知乎问题：")]),t._v(" "),s("ul",[s("li",[t._v("https://www.zhihu.com/question/319494477")]),t._v(" "),s("li",[t._v("https://www.zhihu.com/question/266814164")])]),t._v(" "),s("h2",{attrs:{id:"q-如果项目-usebuiltins-配置按需加载-且项目代码中未使用-map-而第三方库使用了-map-目标兼容-ie11-会出现什么问题-怎么解决"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q-如果项目-usebuiltins-配置按需加载-且项目代码中未使用-map-而第三方库使用了-map-目标兼容-ie11-会出现什么问题-怎么解决"}},[t._v("#")]),t._v(" Q：如果项目 useBuiltIns 配置按需加载，且项目代码中未使用 Map，而第三方库使用了 Map ，目标兼容 ie11 ，会出现什么问题？怎么解决？")]),t._v(" "),s("p",[t._v("将导致运行时报错。可以手动添加 Polyfill ，或者改用 entry 的 useBuiltIns 配置")]),t._v(" "),s("h2",{attrs:{id:"q-如何避免不必要的-polyfill-加载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q-如何避免不必要的-polyfill-加载"}},[t._v("#")]),t._v(" Q：如何避免不必要的 Polyfill 加载？")]),t._v(" "),s("p",[t._v("有两种解决思路：")]),t._v(" "),s("ol",[s("li",[t._v("使用 polyfill.io 这类线上方案\n"),s("ul",[s("li",[t._v("原理：根据 UA 动态加载差异 Polyfill")]),t._v(" "),s("li",[t._v("优点：项目中仅需处理语法，无需处理 api polyyfill")]),t._v(" "),s("li",[t._v("缺点：项目代码中的语法还是得转译，转译语法执行性能相对较差")])])]),t._v(" "),s("li",[t._v("使用 @vitejs/plugin-legacy 的解决方案")])]),t._v(" "),s("ul",[s("li",[t._v("利用 script 的 module/nomodule 特性差异化加载，现代浏览器走 module 逻辑+剩余差异 Polyfill，传统浏览器走语法转译+Polyfill")]),t._v(" "),s("li",[t._v("优点：优先保证大多数现代浏览器的加载体验，少部分浏览器再走语法编译逻辑")]),t._v(" "),s("li",[t._v("缺点：产物文件较多；少部分版本的浏览器存在 ESM 文件重复加载的问题；发展时间短，可能有隐藏问题")]),t._v(" "),s("li",[t._v("更多细节可以看这 2 篇文章：\n"),s("ul",[s("li",[s("a",{attrs:{href:"https://juejin.cn/post/7217449801633628215",target:"_blank",rel:"noopener noreferrer"}},[t._v("【原理揭秘】Vite 是怎么兼容老旧浏览器的？你以为仅仅依靠 Babel？"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.cn/book/7050063811973218341/section/7066611951547187214",target:"_blank",rel:"noopener noreferrer"}},[t._v("深入浅出 Vite"),s("OutboundLink")],1)])])])]),t._v(" "),s("h2",{attrs:{id:"q-vitejs-plugin-legacy-方案还会对第三方库进行处理-具体怎么做的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q-vitejs-plugin-legacy-方案还会对第三方库进行处理-具体怎么做的"}},[t._v("#")]),t._v(" Q: @vitejs/plugin-legacy 方案还会对第三方库进行处理，具体怎么做的？")]),t._v(" "),s("p",[t._v("对现代编译的输出代码再次进行 babel 编译而已。")]),t._v(" "),s("p",[t._v("具体代码在"),s("a",{attrs:{href:"https://github.com/vitejs/vite/blob/main/packages/plugin-legacy/src/index.ts#L433",target:"_blank",rel:"noopener noreferrer"}},[t._v("这"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// raw 是现代编译的输出代码")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" result "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" babel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("raw"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("babelrc")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("configFile")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("compact")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("build"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("minify"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        sourceMaps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("inputSourceMap")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sourceMaps ? chunk.map : undefined, `.map` TODO: moved to OutputChunk?")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("presets")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// forcing our plugin to run before preset-env by wrapping it in a")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// preset so we can catch the injected import statements...")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("plugins")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("recordAndRemovePolyfillBabelPlugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("legacyPolyfills"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("replaceLegacyEnvBabelPlugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wrapIIFEBabelPlugin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@babel/preset-env'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createBabelPresetEnvOptions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("targets"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              needPolyfills"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ignoreBrowserslistConfig")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ignoreBrowserslistConfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br")])]),s("h2",{attrs:{id:"q-部署-polyfill-io-这类方案-需要注意什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q-部署-polyfill-io-这类方案-需要注意什么"}},[t._v("#")]),t._v(" Q：部署 polyfill.io 这类方案，需要注意什么？")]),t._v(" "),s("p",[t._v("polyfill.io 根据 ua 对比自动下发差异，提供"),s("a",{attrs:{href:"https://github.com/JakeChampion/polyfill-service",target:"_blank",rel:"noopener noreferrer"}},[t._v("开源部署方案"),s("OutboundLink")],1),t._v("，使用时需要注意：")]),t._v(" "),s("ul",[s("li",[t._v("时刻关注 browserlist 变化")]),t._v(" "),s("li",[t._v("需要部署 CDN 边缘服务")]),t._v(" "),s("li",[t._v("异常 UA （比如国产浏览器）无法识别，只能走降级兜底策略")]),t._v(" "),s("li",[t._v("不能处理语法层面")])]),t._v(" "),s("h2",{attrs:{id:"q-有哪些常用的-browserslist-配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q-有哪些常用的-browserslist-配置"}},[t._v("#")]),t._v(" Q: 有哪些常用的 browserslist 配置")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("// .browserslistrc\n// 现代浏览器\nlast 2 versions and since 2018 and > 0.5%\n// 兼容低版本 PC 浏览器\nIE >= 11, > 0.5%, not dead\n// 兼容低版本移动端浏览器\niOS >= 9, Android >= 4.4, last 2 versions, > 0.2%, not dead\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("h1",{attrs:{id:"最佳方案是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#最佳方案是什么"}},[t._v("#")]),t._v(" 最佳方案是什么")]),t._v(" "),s("p",[t._v("目标：尽可能快的打包，尽可能少的加载产物，尽可能快的执行代码，绝对安全的加载代码（避免第三方依赖语法和 api 缺失的报错问题）")]),t._v(" "),s("p",[t._v("一个终极方案是：")]),t._v(" "),s("ol",[s("li",[t._v("打包不处理 Polyfill ，走 "),s("code",[t._v("polyfill.io")]),t._v(" ：少掉分析步骤，尽可能快的打包，尽可能少的加载产物")]),t._v(" "),s("li",[t._v("业务产物走 script 的 module/nomodule 特性差异化加载方案（类 "),s("code",[t._v("@vitejs/plugin-legacy")]),t._v(" 方案）：尽可能快的执行代码，绝对安全的执行代码")]),t._v(" "),s("li",[t._v("线上真机白屏检测卡点：绝对安全的执行代码")])]),t._v(" "),s("p",[t._v("当然，要完成这套方案成本较高，可以根据各自公司基建能力和业务诉求来做，最合适的才是最佳的。")]),t._v(" "),s("p",[t._v("成本最低效果又不错的方案就是直接使用 "),s("code",[t._v("@vitejs/plugin-legacy")]),t._v("：尽可能快的执行代码，绝对安全的加载代码，相对快的打包、相对少的加载产物")]),t._v(" "),s("h1",{attrs:{id:"拓展阅读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拓展阅读"}},[t._v("#")]),t._v(" 拓展阅读")]),t._v(" "),s("ol",[s("li",[s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/58624930",target:"_blank",rel:"noopener noreferrer"}},[t._v("Babel学习系列"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://juejin.im/post/5d7efbbb6fb9a06b2650c74a",target:"_blank",rel:"noopener noreferrer"}},[t._v("不要肆无忌惮地在你的项目中使用 ES78910 了"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);