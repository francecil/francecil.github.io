(window.webpackJsonp=window.webpackJsonp||[]).push([[136],{916:function(s,t,a){"use strict";a.r(t);var n=a(30),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("本文探讨了 "),t("code",[s._v("chrome.storage")]),s._v(" 的优缺点，简单介绍了 IndexedDB 技术，并通过一个案例探讨 "),t("code",[s._v("chrome.storage")]),s._v(" 应该如何进行上层封装以支持复杂场景")]),s._v(" "),t("p",[s._v("如无特殊说明，本文提到的插件均指 Chrome 浏览器拓展")]),s._v(" "),t("h2",{attrs:{id:"背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),t("p",[s._v("开发浏览器拓展的时候，数据存储我们一般是用 "),t("code",[s._v("chrome.storage")]),s._v("。相比 localStore 具有数据同步、读写异步、模块互通、支持对象存储等优势。")]),s._v(" "),t("blockquote",[t("p",[s._v("如果想了解 "),t("code",[s._v("chrome.storage")]),s._v(" 的更多内容，请查看 "),t("a",{attrs:{href:"https://developer.chrome.com/docs/extensions/reference/storage/",target:"_blank",rel:"noopener noreferrer"}},[s._v("chrome.storage"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("一般情况下，"),t("code",[s._v("chrome.storage")]),s._v(" 提供的 API 就够用了")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("get(keys?: string | string[] | object)")])]),s._v(" "),t("li",[t("code",[s._v("set(items: object)")]),s._v(" "),t("blockquote",[t("p",[s._v("参数为一个对象，键未存在新增，存在进行更新，已有的其他键不受影响。相当于 "),t("code",[s._v("Object.assign")])])])]),s._v(" "),t("li",[s._v("remove")])]),s._v(" "),t("p",[s._v("但是当数据存储结构较为复杂，且存储结构可能出现变更时，原有 API 就不够用了。")]),s._v(" "),t("h2",{attrs:{id:"案例分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#案例分析"}},[s._v("#")]),s._v(" 案例分析")]),s._v(" "),t("p",[s._v("举个例子，某传统公司 KJ 的图书借阅是通过一款浏览器拓展来完成的（没有涉及服务端，纯本地应用，图书借阅需要去行政的电脑上登记，拓展及数据都在该电脑上）")]),s._v(" "),t("p",[s._v("开发小 A 没啥经验，设计了如下的数据结构：")]),s._v(" "),t("div",{staticClass:"language-ts line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ts"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    employees"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            no"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("number")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 工号")]),s._v("\n            name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            books"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("number")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 书本唯一 id")]),s._v("\n                    name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 书本名")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("该插件用了一段时间，可以查看每个人的借书情况。")]),s._v(" "),t("p",[s._v("但是后来发现无法查询未被借走的书籍情况，于是给小 A 提了需求。小 A 将数据结构改造如下：")]),s._v(" "),t("div",{staticClass:"language-ts line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ts"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    books"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("number")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 书本唯一 id")]),s._v("\n            name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 书本名")]),s._v("\n            employeeNo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("number")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当前归属， -1 表示未被借走")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    employees"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            no"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("number")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 工号")]),s._v("\n            name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("正当小 A 打包完浏览器拓展准备上线时，突然发现一个问题：按这个数据结构，新的代码访问 books 表将找不到数据，且丢失了借阅情况。")]),s._v(" "),t("p",[s._v("此外还引发了另一个问题：原先查询某个员工的借阅情况，我们只需找到该员工，取 books 值就行，现在需要对 books 列表进行筛选，速度变慢了。")]),s._v(" "),t("p",[s._v("这两个问题在数据库中有专门的名称，一个是"),t("strong",[s._v("表升级")]),s._v("，另一个"),t("strong",[s._v("是索引")])]),s._v(" "),t("p",[s._v("在探讨 "),t("code",[s._v("chrome.storage")]),s._v(" 如何解决前，我们先来看看前端 Web 的另一种数据存储方案 -- IndexedDB")]),s._v(" "),t("h2",{attrs:{id:"indexeddb-技术介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#indexeddb-技术介绍"}},[s._v("#")]),s._v(" IndexedDB 技术介绍")]),s._v(" "),t("p",[s._v("IndexedDB 是一种底层 API，用于在客户端存储大量的结构化数据（也包括文件/二进制大型对象（blobs））。该 API 使用索引实现对数据的高性能搜索")]),s._v(" "),t("blockquote",[t("p",[s._v("引自 "),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API",target:"_blank",rel:"noopener noreferrer"}},[s._v("MDN"),t("OutboundLink")],1)])]),s._v(" "),t("ol",[t("li",[s._v("表升级")])]),s._v(" "),t("p",[s._v("必须要在 request.onupgradeneeded 中进行表创建/更新操作")]),s._v(" "),t("p",[s._v("旧版本的数据库无法访问新版本创建的表，同个表旧版本访问的也只是旧的配置")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("事务")]),s._v(" "),t("li",[s._v("索引")])]),s._v(" "),t("p",[s._v("可以指定该索引是否为唯一值")]),s._v(" "),t("p",[s._v("可以增快查询速度")]),s._v(" "),t("p",[s._v("MDN 提供的参考链接有 Polyfill & 包装")]),s._v(" "),t("h2",{attrs:{id:"实现方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现方案"}},[s._v("#")]),s._v(" 实现方案")]),s._v(" "),t("p",[s._v("哪些特性")]),s._v(" "),t("p",[s._v("怎么实现")]),s._v(" "),t("h2",{attrs:{id:"兼容迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#兼容迁移"}},[s._v("#")]),s._v(" 兼容迁移")]),s._v(" "),t("p",[s._v("用户的旧版本拓展，采用传统 storage 不兼容，想用这套方案怎么办？")]),s._v(" "),t("p",[s._v("版本 0")]),s._v(" "),t("h2",{attrs:{id:"后续"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#后续"}},[s._v("#")]),s._v(" 后续")]),s._v(" "),t("p",[s._v("给 localForce 提 MR ，支持 chrome.storage ，")]),s._v(" "),t("p",[s._v("结合 PWA 视图更新，当拓展未下载时，保证本地存储可用")])])}),[],!1,null,null,null);t.default=e.exports}}]);