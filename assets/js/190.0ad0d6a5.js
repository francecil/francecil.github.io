(window.webpackJsonp=window.webpackJsonp||[]).push([[190],{516:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"sw-注册过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sw-注册过程"}},[s._v("#")]),s._v(" sw 注册过程")]),s._v(" "),t("h3",{attrs:{id:"作用域"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#作用域"}},[s._v("#")]),s._v(" 作用域")]),s._v(" "),t("p",[s._v("表示某 sw 文件可以控制的页面范围，默认作用域为 sw 文件的 path")]),s._v(" "),t("blockquote",[t("p",[s._v("注意是页面纬度的，和页面里的资源的请求地址没有关系")])]),s._v(" "),t("p",[s._v("举例，以下页面（xxx.com/index.html）加载了一个 "),t("code",[s._v("/a/b/")]),s._v(" 路径的文件")]),s._v(" "),t("div",{staticClass:"language-html line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-html"}},[t("code",[t("span",{pre:!0,attrs:{class:"token doctype"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<!")]),t("span",{pre:!0,attrs:{class:"token doctype-tag"}},[s._v("DOCTYPE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token name"}},[s._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("head")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("title")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("Service Worker Demo"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("title")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("head")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token script"}},[t("span",{pre:!0,attrs:{class:"token language-javascript"}},[s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'serviceWorker'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" navigator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        navigator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("serviceWorker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("register")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./a/b/sw.js'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("reg")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("reg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    ")])]),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("body")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("则此 sw 文件只能控制 "),t("code",[s._v("xxx.com/a/b/")]),s._v(" 下的页面，不能控制 "),t("code",[s._v("xxx.com/index.html")]),s._v(" 这个页面以及 "),t("code",[s._v("xxx.com/a/c/")]),s._v(" 的页面")]),s._v(" "),t("blockquote",[t("p",[s._v("这里说的控制即这些页面应用 sw ,由 sw 接管缓存")])]),s._v(" "),t("p",[s._v("还可以进一步指定默认作用域的子作用域，且必须是默认作业域的子作用域，比如 /a/b/d")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("navigator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("serviceWorker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("register")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'./a/b/sw.js'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("scope")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/a/b/d/'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("如果设置其他作用域比如 "),t("code",[s._v("/a/c")]),s._v(" 就会报错")]),s._v(" "),t("p",[s._v("如果真想提升 sw 的作用域，有方法么？也是有的，可以设置 sw 文件的响应头，修改「最大作用域」")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Service-Worker-Allowed: /a/c/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("表明该 sw 文件允许接管 "),t("code",[s._v("/a/c/")]),s._v(" 路径下的页面")]),s._v(" "),t("p",[s._v("举例，对于这个页面 https://fe-examples.github.io/pwa-examples/scope/index.html")]),s._v(" "),t("p",[s._v("加载了 "),t("code",[s._v("/scope/page/sw.js")]),s._v(" ，却配置了 "),t("code",[s._v("/scope/p2")]),s._v(" 的作用域，默认是会报错的")]),s._v(" "),t("p",[s._v("通过代理给这个文件加响应头")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("https://fe-examples.github.io/pwa-examples/scope/page/page_sw.js resHeaders://"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("resHeader.json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#resHeader.json")]),s._v("\nService-Worker-Allowed: https://fe-examples.github.io/pwa-examples/scope/p2/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("则不再报错，sw 文件拥有 /scope/p2 的作用域了，可以成功代理请求")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Q: 响应头和配置的作用域不一致会怎样？\nA: 可以不一致，响应头表示的是最大作用域，配置的作用域必须是最大作用域的子集，否则还是报错\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"作用域污染"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#作用域污染"}},[s._v("#")]),s._v(" 作用域污染")]),s._v(" "),t("p",[s._v("多个 sw 控制一个页面的情况，或者某个页面不受预期的被控制，即作用域污染。")]),s._v(" "),t("p",[s._v("举例：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(".\n└── demo\n    ├── a/\n    │   ├── a-sw.js\n    │   └── index.html\n    ├── b/\n    │   └── index.html\n    └── root-sw.js\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("/a/index.html 加载的 /a/a-sw.js ，仅能控制 a 的页面")]),s._v(" "),t("p",[s._v("/b/index.html 加载的 /root-sw.js ，可以控制所有页面")]),s._v(" "),t("p",[s._v("为了使 a 页面仅被 a-sw 控制，需要：\n注销非当前作用域的 sw ，重新注册自己作用域的 sw")]),s._v(" "),t("p",[s._v("Q: 作用域污染有什么影响？\nA: 页面被不受预期的 sw 控制，可能导致访问异常。由于各个作用域页面的控制权不一定是同个开发者，导致问题排查难度变大")]),s._v(" "),t("h3",{attrs:{id:"注册原则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注册原则"}},[s._v("#")]),s._v(" 注册原则")]),s._v(" "),t("p",[s._v("spa: sw 放根目录，index.html 中引用，即作用域为 /\nmpa: 根据业务结构决定单个还是多个\n- 单个：业务相似度高，公共资源和请求较多\n- 多个：不同 path 差异较大，相当于不同子站，公共资源和请求较少。比如不同的活动页。需要注意污染问题")]),s._v(" "),t("h3",{attrs:{id:"更新"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更新"}},[s._v("#")]),s._v(" 更新")]),s._v(" "),t("p",[s._v("浏览器可以根据 url 或文件内容变更检测到 sw 升级")]),s._v(" "),t("p",[s._v("实践中我们更常用 url 带版本号链接的方式  "),t("code",[s._v("./sw.js?v=12323")]),s._v(" 方便追踪版本")]),s._v(" "),t("p",[s._v("sw 更新升级时，浏览器进行异步处理：重新触发注册、安装、激活、控制页面")]),s._v(" "),t("h3",{attrs:{id:"容错"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#容错"}},[s._v("#")]),s._v(" 容错")]),s._v(" "),t("p",[s._v("线上 sw 有 bug 怎么办？两个方式：")]),s._v(" "),t("ol",[t("li",[s._v("走 bugfix 页面上线流程，代码里注销 sw (西瓜创作平台的实现方式)")]),s._v(" "),t("li",[s._v("【推荐】sw 注册时通过「开关」请求进行容错降级，该开关请求不可被缓存，可快速上线。\na. 可以是一个 ajax 接口请求\nb. 也可以是一个带全局 flag 变量的 js 脚本\nc. 如果无网，加载不了这个开关，不进行 sw 注销")])]),s._v(" "),t("h2",{attrs:{id:"工作原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#工作原理"}},[s._v("#")]),s._v(" 工作原理")]),s._v(" "),t("h3",{attrs:{id:"生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生命周期"}},[s._v("#")]),s._v(" 生命周期")]),s._v(" "),t("p",[s._v("注册")]),s._v(" "),t("p",[s._v("安装\n进行预缓存")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addEventListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'install'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("event")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("preCache")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" cache "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" caches"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'static-v1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" cache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addAll")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/about/'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/static/styles.css'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("waitUntil")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("preCache")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("激活\n激活后，可以监听 fetch 事件")]),s._v(" "),t("p",[s._v("控制各个事件成功")]),s._v(" "),t("ol",[t("li",[s._v("注册")]),s._v(" "),t("li",[s._v("执行 sw 代码，若无报错，执行 3")]),s._v(" "),t("li",[s._v("执行 install 回调")])]),s._v(" "),t("p",[s._v("安装失败即终结生命周期，那怎么算是安装失败？")]),s._v(" "),t("p",[s._v("里面抛异常也不行，需要通过 waitUntil 方法拓展生命周期")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addEventListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'install'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("event")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 引入 event.waitUntil 方法")]),s._v("\n  event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("waitUntil")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Promise")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("resolve"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reject")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 模拟 promise 返回错误结果的情况")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reject")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'安装出错'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// resolve('安装成功')")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("同样，激活里面也可以通过 waitUntil 延迟激活时机，与 install 不同的是，reject 不影响激活，始终会激活成功")]),s._v(" "),t("p",[s._v("https://developer.mozilla.org/zh-CN/docs/Web/API/ExtendableEvent/waitUntil")]),s._v(" "),t("p",[s._v("Q: 注销旧的，并安装新的，会发生什么情况？\nA: 同 sw 更新，旧的会走注销流程，但由于这个过程是异步的，在完全注销前，还是能够 fetch 请求")]),s._v(" "),t("h3",{attrs:{id:"终端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#终端"}},[s._v("#")]),s._v(" 终端")]),s._v(" "),t("p",[s._v("多个终端共用 sw 工作线程")]),s._v(" "),t("p",[s._v("sw 激活和 sw 控制是不同的事")]),s._v(" "),t("p",[s._v("被动激活，同时会 sw 控制；\n通过 skipWaiting api 进行手动激活，页面需要再次刷新才能被 sw 控制，可以通过 clientsClaim api 主动控制未受 sw 控制的终端")]),s._v(" "),t("h3",{attrs:{id:"激活的时机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#激活的时机"}},[s._v("#")]),s._v(" 激活的时机")]),s._v(" "),t("p",[s._v("默认：首次安装会立即激活，但是不会控制页面，需要再次刷新页面才会\n更新：已被 sw 控制的页面进行刷新，触发 sw 更新，")]),s._v(" "),t("p",[s._v("sw 更新后，处于 waiting 态，需要关闭所有相关终端，重新打开页面才能激活")]),s._v(" "),t("p",[s._v("对于开发以及用户都不太友好")]),s._v(" "),t("p",[s._v("有以下解决方案")]),s._v(" "),t("ol",[t("li",[s._v("devtool 勾选 upload on reload 选项。当页面 reload ，将强制更新 sw 并激活。")])]),s._v(" "),t("blockquote",[t("p",[s._v("注意：如果更新了 sw ，首次刷新页面只是安装了 sw，需要再次刷新才能激活。如果在第二次刷新前又改了sw ，则第二次刷新还是仅安装 sw，需要再次刷新才能生效")])]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("devtool 手动点击 skipWaiting ,立即生效\n以上方式对普通用户都不太友好")]),s._v(" "),t("li")]),s._v(" "),t("p",[s._v("skipWaiting: 跳过激活")]),s._v(" "),t("h3",{attrs:{id:"更新方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更新方式"}},[s._v("#")]),s._v(" 更新方式")]),s._v(" "),t("p",[s._v("手动更新\n24h 自动更新\n用户手动刷新")]),s._v(" "),t("h3",{attrs:{id:"q-a"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#q-a"}},[s._v("#")]),s._v(" Q&A")]),s._v(" "),t("p",[s._v("Q: 为什么首次加载页面，请求无法被拦截？\nA: 默认激活后，但是不会拿到控制权，需要重新刷新页面才有")]),s._v(" "),t("p",[s._v("Q: 激活完成后，页面主要请求都以加载完毕，需要再次访问页面才能进行资源 cache ，需要第三次访问才会实现缓存命中。但要是第二次访问页面时无网，怎么解决？\nA: 通过预缓存技术在 sw 首次安装时主动 cache ，下文会提到")]),s._v(" "),t("p",[s._v("Q: 一个页面在一次加载周期内，可能会先后被不同的 sw 控制，或者旧页面被新 sw 接管。有什么最佳实践么？\nA: 会被不同 sw 控制，表明使用 skipWaiting 进行激活了；预期到缓存数据不一致的现象会导致问题，则不要使用 skipWaiting() 跳过 waiting 状态;\nhttps://zhuanlan.zhihu.com/p/51118741")]),s._v(" "),t("p",[s._v("Q: html 页面是怎么被离线访问的？\nA: 即使离线， sw 仍然在运行，fetch 里面命中了 html 请求，走了缓存。需要注意的是， html 必须采用 network first 的原则")]),s._v(" "),t("blockquote",[t("p",[s._v("之前出了个故障就是 html 没采用 network first ，且没做定时更新策略，开关策略和兜底逻辑；导致页面影响了 24h 才自动更新")])]),s._v(" "),t("p",[s._v("Q: spa 只缓存主路径，但如果访问子路径会报错，怎么解决?\nA: 正常无网在当前页面里访问子路径不会报错，但是如果用户刷新页面就会报错，因为对应的 request url 不在 cache 里；要想避免这个问题就需要把所有关键子路径的页面也做 cache\n两个策略：")]),s._v(" "),t("ol",[t("li",[s._v("sw install 时 cache")]),s._v(" "),t("li",[s._v("spa 路由变更时 cache\n虽然都是同个页面，会造成额外的流量损耗么？")])]),s._v(" "),t("h2",{attrs:{id:"调试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#调试"}},[s._v("#")]),s._v(" 调试")]),s._v(" "),t("h2",{attrs:{id:"离线缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#离线缓存"}},[s._v("#")]),s._v(" 离线缓存")]),s._v(" "),t("p",[s._v("通过 cache api 和 indexed db 实现，前者保存请求响应具体内容，后者维护过期时间.")]),s._v(" "),t("p",[s._v("处理异常情况，实现各种请求响应策略，预缓存")]),s._v(" "),t("p",[s._v("实际应用中我们采用官方的 workbox")]),s._v(" "),t("h3",{attrs:{id:"预缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#预缓存"}},[s._v("#")]),s._v(" 预缓存")]),s._v(" "),t("p",[s._v("通过 cache addAll api 在 sw 安装期间主动 cache")]),s._v(" "),t("p",[s._v("注意重名资源的加载")]),s._v(" "),t("h2",{attrs:{id:"用户留存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用户留存"}},[s._v("#")]),s._v(" 用户留存")]),s._v(" "),t("p",[s._v("探讨了几种提供用户留存的方式")]),s._v(" "),t("p",[s._v("个人觉得 ROI 较低，使用场景不多，")]),s._v(" "),t("h2",{attrs:{id:"性能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#性能"}},[s._v("#")]),s._v(" 性能")]),s._v(" "),t("p",[s._v("讲述了一些提高 pwa 性能的方案")]),s._v(" "),t("p",[s._v("摘抄自：https://developers.google.com/web/fundamentals/primers/service-workers/high-performance-loading")]),s._v(" "),t("h3",{attrs:{id:"使用-app-shell-渲染基础骨架"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-app-shell-渲染基础骨架"}},[s._v("#")]),s._v(" 使用 app shell 渲染基础骨架")]),s._v(" "),t("p",[s._v("https://developers.google.com/web/fundamentals/architecture/app-shell")]),s._v(" "),t("h3",{attrs:{id:"切勿使用-直通式-提取处理程序"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#切勿使用-直通式-提取处理程序"}},[s._v("#")]),s._v(" 切勿使用“直通式”提取处理程序")]),s._v(" "),t("p",[s._v("不需要 fetch 拦截功能时，就不要编写相关处理，其有额外开销")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Don't do this!")]),s._v("\nself"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addEventListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fetch'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("event")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("respondWith")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetch")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"适时使用导航预加载功能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#适时使用导航预加载功能"}},[s._v("#")]),s._v(" 适时使用导航预加载功能")]),s._v(" "),t("p",[s._v("https://developers.google.com/web/updates/2017/02/navigation-preload")]),s._v(" "),t("h2",{attrs:{id:"seo"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#seo"}},[s._v("#")]),s._v(" SEO")]),s._v(" "),t("h3",{attrs:{id:"背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),t("p",[s._v("spa 的 seo 较差，即使 Google 和 百度已经逐渐支持 js 渲染内容爬取，但是还有很多渲染引擎未处理")]),s._v(" "),t("p",[s._v("两种方案：")]),s._v(" "),t("ol",[t("li",[s._v("SSR , 本文不介绍")]),s._v(" "),t("li",[s._v("结合 AMP/MIP 方案")])]),s._v(" "),t("h3",{attrs:{id:"amp-mip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#amp-mip"}},[s._v("#")]),s._v(" AMP/MIP")]),s._v(" "),t("p",[s._v("制定 html 编写规范：https://amp.dev/documentation/guides-and-tutorials/learn/spec/amphtml.html :不支持外链 js")]),s._v(" "),t("p",[s._v("amp 页面的资源加载走 amp cache :Google 的 CDN , 爬虫爬取时认为该页面是 AMP 且符合 AMP 规范即将资源写入缓存，用户从 Google 搜索引擎点击 amp 结果，会创建一个 iframe ,异步打开 amp cache cdn 的 amp html 页面")]),s._v(" "),t("p",[s._v("amp 规范的元素需要依赖 amp js 运行时")]),s._v(" "),t("p",[s._v("限制较多，简单页面/交互较少页面适合使用")]),s._v(" "),t("h3",{attrs:{id:"结合-pwa"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结合-pwa"}},[s._v("#")]),s._v(" 结合 PWA")]),s._v(" "),t("p",[s._v("全站 AMP: 在 amp 基础上增加 sw 支持：支持添加桌面和离线缓存；缺点则 amp 缺点：不支持复杂交互")]),s._v(" "),t("p",[s._v("Q: amp 不支持 外链 js，怎么添加 sw 支持?\nA: 有自己的自定义组件，比如 mip 的 mip-install-serviceworker 组件")]),s._v(" "),t("p",[s._v("AMP 预加载 pwa: amp 作为中间页，预加载 pwa 页面。amp 供搜索引擎爬取")]),s._v(" "),t("p",[s._v("配置原页面地址")]),s._v(" "),t("div",{staticClass:"language-html line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-html"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("rel")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("canonical"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("href")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')]),s._v("https://pwa.host/some/path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("预加载也是用 sw ,sw 里面对 pwa 的资源进行预缓存")]),s._v(" "),t("h2",{attrs:{id:"实战"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实战"}},[s._v("#")]),s._v(" 实战")]),s._v(" "),t("p",[s._v("基于 webpack & workbox 的 demo")]),s._v(" "),t("h2",{attrs:{id:"总结-最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结-最佳实践"}},[s._v("#")]),s._v(" 总结  & 最佳实践")]),s._v(" "),t("p",[s._v("对 sw 不太熟悉，只是尝新，担心造成事故，采用 network-first 准没错")]),s._v(" "),t("p",[s._v("skip")]),s._v(" "),t("h2",{attrs:{id:"其他"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[s._v("#")]),s._v(" 其他")])])}),[],!1,null,null,null);t.default=e.exports}}]);