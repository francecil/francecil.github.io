(window.webpackJsonp=window.webpackJsonp||[]).push([[202],{981:function(s,t,a){"use strict";a.r(t);var n=a(30),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("对于使用 npm 的前端项目，在分支合并时经常会遇到 "),t("code",[s._v("package-lock.json")]),s._v(" 冲突。此时直接执行 "),t("code",[s._v("npm install")]),s._v(" 命令，npm 会自动帮忙解决冲突。")]),s._v(" "),t("p",[s._v("但这是否存在什么问题？又该如何解决？文本将来探讨这个话题，预期收获有：")]),s._v(" "),t("ul",[t("li",[s._v("了解 "),t("code",[s._v("npm install")]),s._v(" 自动解决合并冲突的原理")]),s._v(" "),t("li",[s._v("了解合并冲突修复算法存在的问题，以及如何解决")])]),s._v(" "),t("h1",{attrs:{id:"前置知识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前置知识"}},[s._v("#")]),s._v(" 前置知识")]),s._v(" "),t("ul",[t("li",[s._v("Git 合并冲突原因：两个分支对"),t("strong",[s._v("一个文件")]),s._v("的"),t("strong",[s._v("同一区域")]),s._v("做了修改")]),s._v(" "),t("li",[s._v("Git 合并冲突片段内容：包括 "),t("code",[s._v("当前分支改动")]),s._v("、"),t("code",[s._v("目标分支改动")]),s._v(" 、"),t("code",[s._v("两个分支的最近公共祖先节点在该区域的内容")]),s._v(" 。需要注意的是，第三部分内容（base）需要配置合并冲突展示选项为 "),t("code",[s._v("diff3")]),s._v(" 或者 "),t("code",[s._v("zdiff3")]),s._v(" 才会存在，更多介绍可以看 "),t("a",{attrs:{href:"https://www.gahing.top/pages/17b23b/",target:"_blank",rel:"noopener noreferrer"}},[s._v("开启 diff3，帮助解决 Git 合并冲突难题"),t("OutboundLink")],1),s._v(" 这篇文章。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d1f6ccb13b54cc1bbb03c8d23455136~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),s._v(" "),t("h1",{attrs:{id:"算法流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#算法流程"}},[s._v("#")]),s._v(" 算法流程")]),s._v(" "),t("p",[t("code",[s._v("package-lock.json")]),s._v(" 的冲突修复算法由 "),t("a",{attrs:{href:"https://github.com/npm/parse-conflict-json",target:"_blank",rel:"noopener noreferrer"}},[s._v("npm/parse-conflict-json"),t("OutboundLink")],1),s._v(" 仓库维护，项目 README 简单描述了算法流程：")]),s._v(" "),t("ol",[t("li",[s._v("将冲突文件解析为 3 部分："),t("code",[s._v("ours")]),s._v(" （当前分支内容） , "),t("code",[s._v("theirs")]),s._v(" （目标分支内容）, 以及 "),t("code",[s._v("parent")]),s._v(" （两个分支的公共祖先节点的内容）。")]),s._v(" "),t("li",[s._v("获取 "),t("code",[s._v("parent")]),s._v(" 与 "),t("code",[s._v("ours")]),s._v(" 间的"),t("a",{attrs:{href:"https://github.com/angus-c/just#just-diff",target:"_blank",rel:"noopener noreferrer"}},[s._v("差异（diff）"),t("OutboundLink")],1),s._v("：对象 diff 对比，从 "),t("code",[s._v("parent")]),s._v(" 变化到 "),t("code",[s._v("ours")]),s._v(" 的步骤，包括变更路径（对象key路径）、变更行为（新增、删除、修改）、变更值。")]),s._v(" "),t("li",[s._v("将该差异的每个变更"),t("a",{attrs:{href:"https://github.com/angus-c/just#just-diff-apply",target:"_blank",rel:"noopener noreferrer"}},[s._v("应用"),t("OutboundLink")],1),s._v("到 "),t("code",[s._v("theirs")]),s._v(" 的变更中\n"),t("ol",[t("li",[s._v("如果"),t("strong",[s._v("变更行为")]),s._v("是 "),t("code",[s._v("新增")]),s._v("且"),t("strong",[s._v("变更路径")]),s._v("在 "),t("code",[s._v("theirs")]),s._v(" 中已有值，则"),t("strong",[s._v("变更行为")]),s._v("调整为"),t("strong",[s._v("修改")]),s._v("。")]),s._v(" "),t("li",[s._v("如果无法应用差异变更，（通常是变更路径无法在 "),t("code",[s._v("theirs")]),s._v(" 中找到，见下方例子），则将 "),t("code",[s._v("theirs")]),s._v(" 相应路径中的对象替换为 "),t("code",[s._v("ours")]),s._v(" 路径中的对象。")])])])]),s._v(" "),t("p",[t("strong",[s._v("一句话总结")]),s._v("：基于 "),t("code",[s._v("theirs")]),s._v("，应用 "),t("code",[s._v("ours")]),s._v(" 的变更。")]),s._v(" "),t("h1",{attrs:{id:"代码流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代码流程"}},[s._v("#")]),s._v(" 代码流程")]),s._v(" "),t("p",[s._v("完整代码在：https://github.com/npm/parse-conflict-json/blob/main/lib/index.js")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PARENT_RE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token regex"}},[t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("|{7,}")]),t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-flags"}},[s._v("g")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("OURS_RE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token regex"}},[t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("<{7,}")]),t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-flags"}},[s._v("g")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("THEIRS_RE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token regex"}},[t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("={7,}")]),t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-flags"}},[s._v("g")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("END_RE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token regex"}},[t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v(">{7,}")]),t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-flags"}},[s._v("g")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("isDiff")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("str")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v("\n  str"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("OURS_RE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" str"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("THEIRS_RE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" str"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("END_RE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("parseConflictJSON")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("str"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reviver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" prefer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 解析冲突内容")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" pieces "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" str"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("split")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token regex"}},[t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[s._v("[\\n\\r]+")]),t("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token regex-flags"}},[s._v("g")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reduce")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" line")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("line"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("PARENT_RE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'parent'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("line"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("OURS_RE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ours'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("line"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("THEIRS_RE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'theirs'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("line"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("END_RE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'top'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'top'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ours'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ours "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" line\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'top'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'theirs'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("theirs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" line\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'top'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("state "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'parent'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        acc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parent "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" line\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" acc\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("state")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'top'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("ours")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("theirs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("parent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 转为对象结构")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" parent "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("parseJSON")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pieces"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reviver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" ours "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("parseJSON")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pieces"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reviver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" theirs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("parseJSON")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pieces"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("theirs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reviver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取结果")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("parent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" theirs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function-variable function"}},[s._v("resolve")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("parent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" theirs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取 parent 对象到 ours 对象的变更")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" dours "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("parent"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 将变更应用到 theirs")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" dours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("diffApply")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("theirs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("dours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 拷贝 ours 的变更路径至 theirs")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("copyPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("theirs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dours"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" theirs\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br")])]),t("h1",{attrs:{id:"实例讲解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实例讲解"}},[s._v("#")]),s._v(" 实例讲解")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"ms"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n<<<<<<< HEAD\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.1.2"')]),s._v("\n||||||| merged common ancestors\n=======\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"version"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.1.3"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"desc"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),s._v("\n>>>>>>> feat4\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n<<<<<<< HEAD\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"c"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"x"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bbbb"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n||||||| merged common ancestors\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"c"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"x"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"aaaa"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n=======\n      "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"c"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxxx"')]),s._v("\n>>>>>>> a\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])]),t("p",[s._v("第一步，解析文件得到 "),t("code",[s._v("ours")]),s._v("、"),t("code",[s._v("theirs")]),s._v("、"),t("code",[s._v("parent")]),s._v(" 的对象值")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b8617c543ca40bab64373c04e3e7c9e~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),s._v(" "),t("p",[s._v("第二步，获取 "),t("code",[s._v("parent")]),s._v(" 与 "),t("code",[s._v("ours")]),s._v(" 的差异：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("增加")]),s._v(" "),t("code",[s._v("ms.version")]),s._v(" 字段，值为 "),t("code",[s._v("2.1.2")])]),s._v(" "),t("li",[t("strong",[s._v("修改")]),s._v(" "),t("code",[s._v("c.x")]),s._v(" 字段，值为 "),t("code",[s._v("bbbb")])])]),s._v(" "),t("p",[s._v("第三步，将差异逐个应用到 "),t("code",[s._v("theirs")])]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("修改（由于变更路径存在值）")]),s._v(" "),t("code",[s._v("theirs")]),s._v(" 中 "),t("code",[s._v("ms.version")]),s._v(" 的值为 "),t("code",[s._v("2.1.2")])]),s._v(" "),t("li",[t("strong",[s._v("修改")]),s._v(" "),t("code",[s._v("theirs")]),s._v(" 中 "),t("code",[s._v("c.x")]),s._v(" 的值为 "),t("code",[s._v("bbbb")]),s._v("，但 "),t("code",[s._v("c.x")]),s._v(" 这个路径无法在 "),t("code",[s._v("theirs")]),s._v(" 中找到，于是将 "),t("code",[s._v("theirs")]),s._v(" 的 "),t("code",[s._v("c")]),s._v(" 取值改成 "),t("code",[s._v("ours")]),s._v(" 的 "),t("code",[s._v("c")]),s._v(" 取值")]),s._v(" "),t("li",[s._v("全部应用完毕，得到如下对象")])]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  ms"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    version"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.1.2"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    desc"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"desc"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    x"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bbbb"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h1",{attrs:{id:"问题分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题分析"}},[s._v("#")]),s._v(" 问题分析")]),s._v(" "),t("p",[s._v("简单来说，冲突合并算法就是基于 "),t("code",[s._v("theirs")]),s._v("，并应用 "),t("code",[s._v("ours")]),s._v(" 的变更。")]),s._v(" "),t("p",[s._v("如果 "),t("code",[s._v("ours")]),s._v(" 或 "),t("code",[s._v("theirs")]),s._v(" 更新了不同的路径，"),t("code",[s._v("package-lock.json")]),s._v(" 最终都会保留。")]),s._v(" "),t("p",[t("strong",[s._v("但如果同时更新了同一路径，比如模块的版本号，则会以 "),t("code",[s._v("ours")]),s._v(" 的版本为准，这在"),t("code",[s._v("极少数情况下")]),s._v("会出错。")])]),s._v(" "),t("blockquote",[t("p",[s._v("这也符合直觉，处于主分支并 merge 开发分支，版本应该尽量以主分支的为准，更稳定")]),s._v(" "),t("p",[s._v("另外对于「开发分支 rebase 主分支」的情况，"),t("code",[s._v("ours")]),s._v(" 和 "),t("code",[s._v("theirs")]),s._v(" 的内容是相反的，即实际也是以主分支的为准")])]),s._v(" "),t("p",[s._v("以两个分支更新同一模块的版本号为例：\n"),t("img",{attrs:{src:"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b22fb560cafc4f598331096cab9985e3~tplv-k3u1fbpfcp-watermark.image?",alt:"image.png"}})]),s._v(" "),t("ol",[t("li",[s._v("同时从"),t("code",[s._v("主分支")]),s._v("拉取了两个开发分支 "),t("code",[s._v("feat1")]),s._v(" 和 "),t("code",[s._v("feat2")]),s._v("。")]),s._v(" "),t("li",[s._v("开发分支 "),t("code",[s._v("feat1")]),s._v(" 安装了依赖 "),t("code",[s._v("A^1.0.0")]),s._v(" ，此时装的版本是 "),t("code",[s._v("1.0.0")]),s._v(" ，"),t("code",[s._v("feat1")]),s._v(" 先合入了"),t("code",[s._v("主分支")]),s._v("。")]),s._v(" "),t("li",[s._v("开发分支 "),t("code",[s._v("feat2")]),s._v(" 还在继续开发，也安装了依赖 "),t("code",[s._v("A^1.0.0")]),s._v("。但此时 A 发了一个有新 API 的 "),t("code",[s._v("1.0.1")]),s._v(" 版本，正好 "),t("code",[s._v("feat2")]),s._v(" 用到了，此时 "),t("code",[s._v("feat2")]),s._v(" 装的版本是 "),t("code",[s._v("1.0.1")]),s._v("。")]),s._v(" "),t("li",[t("code",[s._v("feat2")]),s._v(" 测试完毕 "),t("em",[s._v("（仅测了")]),s._v(" "),t("em",[t("code",[s._v("feat2")])]),s._v(" "),t("em",[s._v("的功能）")]),s._v(" ，于是切换到"),t("code",[s._v("主分支")]),s._v("，并执行 "),t("code",[s._v("git merge feat2")]),s._v(" 命令准备合入 "),t("code",[s._v("feat2")]),s._v(" 的代码")]),s._v(" "),t("li",[s._v("此时发现 lock 文件冲突，于是执行 "),t("code",[s._v("npm install")]),s._v(" 快速解决，lock 文件会选择了 "),t("code",[s._v("ours")]),s._v(" （主分支）的版本，即 "),t("code",[s._v("1.0.0")])]),s._v(" "),t("li",[s._v("没有测试直接上线，结果发现项目中关于 "),t("code",[s._v("feat2")]),s._v(" 的功能报错了")])]),s._v(" "),t("p",[t("strong",[s._v("虽然很少见，但这是业务碰到过的活生生的例子 🩸。")])]),s._v(" "),t("p",[t("strong",[s._v("并且这类问题，在 monorepo 流行后会变得更加常见 — 不同的子包安装了相同依赖的不同版本，且很难 review 到位。。")])]),s._v(" "),t("p",[s._v("那对于这个场景，选择 A 的 "),t("code",[s._v("1.0.1")]),s._v(" 版本可行么？实际上也不靠谱，如果 "),t("code",[s._v("1.0.1")]),s._v(" 出现了 "),t("code",[s._v("BREAKING CHANGE")]),s._v("，那么 "),t("code",[s._v("feat1")]),s._v(" 的功能将报错。。")]),s._v(" "),t("h1",{attrs:{id:"解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[s._v("#")]),s._v(" 解决方案")]),s._v(" "),t("p",[s._v("当出现依赖版本冲突时，没有一劳永逸且稳定的版本选择策略，但可以参考下面这个最佳实践，进行"),t("strong",[s._v("必要的 lockfile 人工 review")]),s._v(" ，并通过"),t("strong",[s._v("合理的开发流程")]),s._v("来保障。")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("冲突解决操作：")]),s._v(" 依然选择 "),t("code",[s._v("npm install")]),s._v(" 解决冲突，如果后面有调整版本的需求再手动更改")]),s._v(" "),t("li",[t("strong",[s._v("版本调整原则：")]),s._v(" 版本默认以主分支为准，若要调整，关注以下两点：\n"),t("ul",[t("li",[s._v("当前需求是否用到默认版本所不拥有的新接口，如果是则尝试调整为当前需求的版本")]),s._v(" "),t("li",[s._v("调整至当前需求版本后，是否存在 "),t("code",[s._v("BREAKING CHANGE")]),s._v("。如果是，则不推荐使用这个依赖，或者此依赖分属 monorepo 的不同子包，则采用固定版本的写法。")])])]),s._v(" "),t("li",[t("strong",[s._v("合理的开发流程：")]),s._v(" 及时 rebase 、变更复测\n"),t("ul",[t("li",[s._v("开发阶段，及时 merge 或者 rebase 主分支的代码，有冲突提前解，而不是等到提测后要上线的时候再去处理。")]),s._v(" "),t("li",[s._v("提测后合码前，如果发现代码冲突，解决冲突并合码上线前最好再重新测试一下代码冲突相关的场景（如果项目重要和人力允许的话）。")])])]),s._v(" "),t("li",[t("strong",[s._v("必要的 lockfile 人工 review：")]),s._v(" 仅需关注"),t("strong",[s._v("直接依赖")]),s._v("（比如 "),t("code",[s._v("pnpm-lock.yaml")]),s._v(" 文件的 "),t("code",[s._v("specifier")]),s._v(" 和 "),t("code",[s._v("version")]),s._v(" 部分）的版本变更，对于"),t("strong",[s._v("直接依赖")]),s._v("引入的"),t("strong",[s._v("间接依赖")]),s._v("，自动升级出错的概率较小（一旦出错影响的不只一个项目），且 review 成本太高，选择信任社区，也可选择「变更复测」来保障。")])]),s._v(" "),t("h1",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("本文系统分析了 "),t("code",[s._v("npm i")]),s._v(" 解决 "),t("code",[s._v("package-lock.json")]),s._v(" 冲突的算法策略，即基于 "),t("code",[s._v("theirs")]),s._v(" 并应用 "),t("code",[s._v("ours")]),s._v(" 的变更。")]),s._v(" "),t("p",[s._v("该策略在绝大多数情况下有效，但对于某些边缘场景，粗暴的选择某个依赖的版本会导致问题。")]),s._v(" "),t("p",[s._v("对于这类问题，目前没有（也很难有）一劳永逸的解决方案，要么信任社区并听天由命，要么通过文本提到的 「必要的 lockfile 人工 review」 + 「合理的开发流程」来保障。")]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("最后，如果看完本文有收获，欢迎一键三连（点赞、收藏、分享）🍻 ~")])])}),[],!1,null,null,null);t.default=e.exports}}]);